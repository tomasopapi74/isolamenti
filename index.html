<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Isolamenti Agricoli - Cloud Sync & Recovery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        #map { height: calc(100vh - 80px); width: 100%; z-index: 1; }
        .custom-popup .leaflet-popup-content-wrapper { border-radius: 12px; padding: 8px; }
        
        .pulse-user {
            width: 18px; height: 18px; background: #3b82f6; border: 3px solid white; border-radius: 50%;
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 12px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
        }

        #statusPanel { transition: transform 0.3s cubic-bezier(0.17, 0.67, 0.83, 0.67); touch-action: none; padding-bottom: env(safe-area-inset-bottom); }
        .drag-handle { width: 40px; height: 5px; background-color: #cbd5e1; border-radius: 10px; margin: 0 auto 10px auto; }
        
        #loginOverlay {
            position: fixed; inset: 0; background: #f8fafc; z-index: 9999;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
    </style>
</head>
<body class="bg-slate-50 font-sans overflow-hidden">

    <!-- Schermata di Login / Accesso Progetto -->
    <div id="loginOverlay">
        <div class="bg-white p-8 rounded-[32px] shadow-2xl w-full max-w-md space-y-6">
            <div class="text-center space-y-2">
                <div class="bg-green-100 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="cloud-lightning" class="text-green-600 w-8 h-8"></i>
                </div>
                <h1 class="text-2xl font-black text-slate-800 tracking-tight">Accesso Progetto</h1>
                <p class="text-slate-500 text-sm italic">Sincronizzazione Cloud sicura per il tuo gruppo di lavoro.</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Nome Gruppo</label>
                    <input type="text" id="projectInput" placeholder="es: Squadra_Nord" 
                        class="w-full border border-slate-200 rounded-2xl p-4 focus:ring-2 focus:ring-green-500 outline-none text-sm bg-slate-50">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Password Progetto</label>
                    <input type="password" id="passwordInput" placeholder="Scegli una password" 
                        class="w-full border border-slate-200 rounded-2xl p-4 focus:ring-2 focus:ring-green-500 outline-none text-sm bg-slate-50">
                </div>
                <button onclick="handleLogin()" id="loginBtn" class="w-full bg-green-600 text-white py-4 rounded-2xl font-black text-sm shadow-lg shadow-green-100 active:scale-95 transition-all disabled:opacity-50">
                    ACCEDI O CREA PROGETTO
                </button>
            </div>
            <p id="loginError" class="text-red-500 text-xs text-center font-bold hidden px-4 leading-relaxed"></p>
        </div>
    </div>

    <header class="bg-white shadow-md p-4 sticky top-0 z-50 border-b border-slate-100 h-[80px]">
        <div class="max-w-6xl mx-auto flex items-center gap-4">
            <div class="flex items-center gap-2 shrink-0">
                <div class="bg-green-600 p-2 rounded-lg shadow-md">
                    <i data-lucide="leaf" class="text-white w-5 h-5"></i>
                </div>
                <div class="hidden sm:block text-green-700">
                    <h1 class="text-lg font-bold text-slate-800 leading-none" id="displayProjName">Isolamenti</h1>
                    <span class="text-[10px] font-bold uppercase tracking-widest">Sincronizzazione Attiva</span>
                </div>
            </div>
            
            <div class="flex-1 flex gap-2">
                <div class="relative flex-1">
                    <i data-lucide="search" class="absolute left-3 top-3 text-slate-400 w-4 h-4"></i>
                    <input type="text" id="searchInput" placeholder="Cerca Campo..." 
                        class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none text-sm shadow-inner bg-slate-50">
                </div>
                <button onclick="handleSearch()" class="bg-green-600 text-white px-4 py-2 rounded-xl font-semibold hover:bg-green-700 active:scale-95 transition-all">
                    Cerca
                </button>
            </div>
        </div>
    </header>

    <main class="relative">
        <div id="map"></div>

        <div class="absolute top-4 left-4 z-[1000] flex flex-col gap-2">
            <button onclick="recenterOnUser()" class="bg-white p-3 rounded-xl shadow-lg text-slate-700 border border-slate-100 active:scale-90 transition-transform">
                <i data-lucide="locate-fixed" class="w-5 h-5"></i>
            </button>
            <button onclick="openManualCoordModal()" class="bg-white p-3 rounded-xl shadow-lg text-slate-700 border border-slate-100 active:scale-90 transition-transform">
                <i data-lucide="map-pin" class="w-5 h-5"></i>
            </button>
        </div>

        <div id="telemetryPanel" class="absolute top-4 right-4 z-[1000] hidden">
            <div class="bg-white/90 backdrop-blur px-3 py-2 rounded-xl shadow-lg border border-slate-100 text-[10px] font-bold text-slate-600 flex items-center gap-2">
                <div class="flex flex-col"><span class="text-slate-400 uppercase tracking-tighter">GPS</span><span id="accuracyVal">--m</span></div>
                <div id="syncIndicator" class="text-green-500"><i data-lucide="cloud-check" class="w-4 h-4"></i></div>
            </div>
        </div>

        <!-- BOTTOM SHEET -->
        <div id="statusPanel" class="absolute bottom-0 left-0 right-0 bg-white shadow-[0_-10px_40px_-5px_rgba(0,0,0,0.15)] rounded-t-[32px] p-5 z-[1000] border-t border-slate-200 max-h-[85vh] flex flex-col translate-y-[calc(100%-85px)]">
            <div id="dragArea" class="cursor-grab active:cursor-grabbing pb-4 -mt-2 shrink-0">
                <div class="drag-handle"></div>
                <div class="flex items-center justify-between">
                    <span class="text-[10px] font-black uppercase tracking-widest text-slate-500">Pannello Campi</span>
                    <div id="statusIndicator" class="flex items-center gap-2 px-3 py-1 rounded-full text-[10px] font-bold bg-slate-100 text-slate-600 transition-colors">
                        <span id="statusDot" class="w-2.5 h-2.5 rounded-full bg-slate-400"></span>
                        <span id="statusText">GPS Off</span>
                    </div>
                </div>
            </div>

            <div id="panelContent" class="space-y-6 overflow-y-auto custom-scrollbar flex-1 pb-6 opacity-40">
                <div id="infoBox" class="space-y-3">
                    <div class="flex gap-2">
                        <button id="trackBtn" onclick="toggleTracking()" class="flex-1 flex items-center justify-center gap-2 bg-slate-900 text-white py-3 rounded-xl font-bold active:scale-95 shadow-md">
                            <i data-lucide="navigation" class="w-4 h-4"></i> Attiva GPS
                        </button>
                        <button onclick="logoutProject()" class="bg-slate-100 text-slate-500 p-3 rounded-xl hover:bg-slate-200 transition-colors">
                            <i data-lucide="log-out" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <div id="fieldsSection" class="space-y-6">
                    <div id="cat-cipolle" class="hidden">
                        <div class="flex items-center gap-2 mb-3"><div class="w-1 h-4 bg-orange-500 rounded-full"></div><h3 class="text-xs font-black uppercase text-slate-600 tracking-wider">Cipolle</h3></div>
                        <div id="list-cipolle" class="space-y-2"></div>
                    </div>
                    <div id="cat-bunching" class="hidden">
                        <div class="flex items-center gap-2 mb-3"><div class="w-1 h-4 bg-green-500 rounded-full"></div><h3 class="text-xs font-black uppercase text-slate-600 tracking-wider">Bunching</h3></div>
                        <div id="list-bunching" class="space-y-2"></div>
                    </div>
                    <div id="cat-brassiche" class="hidden">
                        <div class="flex items-center gap-2 mb-3"><div class="w-1 h-4 bg-purple-500 rounded-full"></div><h3 class="text-xs font-black uppercase text-slate-600 tracking-wider">Brassiche</h3></div>
                        <div id="list-brassiche" class="space-y-2"></div>
                    </div>
                    <div id="emptyMsg" class="text-center py-8 text-slate-400 text-xs italic">Nessun campo nel progetto Cloud.</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Scelta Azione -->
    <div id="actionChoiceModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-[2000] p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
            <h2 class="text-lg font-bold text-slate-800 mb-6 text-center">Cosa vuoi fare?</h2>
            <div class="flex flex-col gap-4">
                <button onclick="selectNewField()" class="flex items-center justify-between bg-green-50 text-green-700 p-4 rounded-2xl border border-green-200 active:scale-95 transition-all">
                    <div class="flex items-center gap-3"><i data-lucide="plus-circle" class="w-6 h-6"></i><span class="font-bold">Nuovo Isolamento</span></div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-green-400"></i>
                </button>
                <button onclick="selectNewCheckpoint()" class="flex items-center justify-between bg-blue-50 text-blue-700 p-4 rounded-2xl border border-blue-200 active:scale-95 transition-all">
                    <div class="flex items-center gap-3"><i data-lucide="clipboard-check" class="w-6 h-6"></i><span class="font-bold">Aggiungi Nota</span></div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-blue-400"></i>
                </button>
                <button onclick="closeActionChoiceModal()" class="mt-2 text-slate-400 text-sm font-bold py-2">Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal Nuovo Campo -->
    <div id="fieldModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-[2000] p-4">
        <div class="bg-white rounded-3xl w-full max-w-md p-6 shadow-2xl animate-in zoom-in duration-200">
            <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2 text-green-700"><i data-lucide="plus-circle"></i> Nuovo Isolamento</h2>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Nome</label>
                        <input type="text" id="fieldNameInput" class="w-full border border-slate-200 rounded-xl p-3 outline-none text-sm bg-slate-50">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Codice</label>
                        <input type="text" id="fieldCodeInput" class="w-full border border-slate-200 rounded-xl p-3 outline-none text-sm bg-slate-50">
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Categoria</label>
                    <select id="fieldCategoryInput" class="w-full border border-slate-200 rounded-xl p-3 outline-none text-sm bg-slate-50">
                        <option value="cipolle">Cipolle</option>
                        <option value="bunching">Bunching</option>
                        <option value="brassiche">Brassiche</option>
                    </select>
                </div>
                <div id="coordsInputs" class="hidden space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="fieldLatInput" step="any" placeholder="Lat" class="w-full border border-slate-200 rounded-xl p-3 text-sm bg-slate-50">
                        <input type="number" id="fieldLonInput" step="any" placeholder="Lon" class="w-full border border-slate-200 rounded-xl p-3 text-sm bg-slate-50">
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Raggio (m)</label>
                    <input type="number" id="fieldRadiusInput" value="1000" class="w-full border border-slate-200 rounded-xl p-3 text-sm bg-slate-50">
                </div>
                <div class="flex gap-3 pt-2">
                    <button onclick="closeFieldModal()" class="flex-1 py-3 border border-slate-200 rounded-xl font-bold text-slate-500 text-sm">Annulla</button>
                    <button onclick="confirmAddField()" class="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold text-sm">Registra</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Checkpoint -->
    <div id="checkpointModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-[2000] p-4">
        <div class="bg-white rounded-3xl w-full max-w-md p-6 shadow-2xl animate-in zoom-in duration-200">
            <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2 text-blue-700"><i data-lucide="clipboard-check"></i> Rilevamento</h2>
            <div class="space-y-4">
                <textarea id="checkpointNoteInput" rows="4" class="w-full border border-slate-200 rounded-xl p-3 outline-none text-sm bg-slate-50" placeholder="Inserisci note..."></textarea>
                <div class="flex gap-3 pt-2">
                    <button onclick="closeCheckpointModal()" class="flex-1 py-3 border border-slate-200 rounded-xl font-bold text-slate-500 text-sm">Annulla</button>
                    <button onclick="confirmAddCheckpoint()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold text-sm">Salva</button>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="fixed top-24 left-1/2 -translate-x-1/2 z-[3000] transform -translate-y-24 opacity-0 transition-all duration-500 bg-slate-900 text-white px-6 py-2.5 rounded-full shadow-2xl text-xs font-bold">
        <span id="notifText"></span>
    </div>

    <!-- Firebase SDK & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // GLOBALS
        let fb = {};
        let map, userMarker, watchId = null, fields = []; 
        let isTracking = false, tempFieldCoords = null, tempCheckpointCoords = null;
        let currentProjectName = null, currentPassword = null, isSyncing = false;

        // Inizializzazione sicura Firebase
        try {
            const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            const firebaseConfig = JSON.parse(firebaseConfigStr);
            const app = initializeApp(firebaseConfig);
            fb.auth = getAuth(app);
            fb.db = getFirestore(app);
            fb.appId = typeof __app_id !== 'undefined' ? __app_id : 'isolamenti-agricoli';
            
            // Metodi Firebase necessari
            fb.doc = doc; fb.setDoc = setDoc; fb.onSnapshot = onSnapshot; 
            fb.getDoc = getDoc; fb.signInAnonymously = signInAnonymously; 
            fb.signInWithCustomToken = signInWithCustomToken;
            
            window.fbReady = true;
            console.log("Firebase Unificato Pronto - AppId:", fb.appId);
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        // Funzione di autenticazione resiliente
        async function authenticate() {
            if (!fb.auth) return null;
            
            // Proviamo fino a 3 volte con intervallo crescente
            for (let attempt = 1; attempt <= 3; attempt++) {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await fb.signInWithCustomToken(fb.auth, __initial_auth_token);
                    } else {
                        await fb.signInAnonymously(fb.auth);
                    }
                    if (fb.auth.currentUser) return fb.auth.currentUser;
                } catch (err) {
                    console.warn(`Auth Attempt ${attempt} failed:`, err);
                    if (attempt < 3) await new Promise(res => setTimeout(res, 1000 * attempt));
                }
            }
            return fb.auth.currentUser || null;
        }

        // LOGIN E CLOUD LOGIC
        window.handleLogin = async function() {
            if (!window.fbReady) {
                const errorEl = document.getElementById('loginError');
                errorEl.innerText = "Configurazione Cloud non pronta. Ricarica la pagina."; 
                errorEl.classList.remove('hidden');
                return;
            }

            const nameRaw = document.getElementById('projectInput').value.trim();
            const name = nameRaw.toLowerCase().replace(/[^a-z0-9_]/g, ''); 
            const pass = document.getElementById('passwordInput').value.trim();
            const errorEl = document.getElementById('loginError');
            
            if (!name || !pass) { 
                errorEl.innerText = "Inserisci nome gruppo e password."; 
                errorEl.classList.remove('hidden'); 
                return; 
            }

            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.innerText = "CONNESSIONE...";
            errorEl.classList.add('hidden');
            
            try {
                // Autenticazione prima di ogni query
                const user = await authenticate();
                if (!user) throw new Error("Errore di rete Cloud: Impossibile autenticare la sessione.");
                
                // Percorso obbligatorio: /artifacts/{appId}/public/data/projects/{name}
                const projRef = fb.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'projects', name);
                const docSnap = await fb.getDoc(projRef);

                if (docSnap.exists()) {
                    const cloudData = docSnap.data();
                    if (cloudData && cloudData.password && cloudData.password !== pass) {
                        errorEl.innerText = "Password errata per questo gruppo."; 
                        errorEl.classList.remove('hidden');
                        loginBtn.innerText = "ACCEDI O CREA PROGETTO";
                        loginBtn.disabled = false;
                        return;
                    }
                } else {
                    if (!confirm(`Il gruppo "${nameRaw}" Ã¨ nuovo. Crearlo con questa password?`)) { 
                        loginBtn.innerText = "ACCEDI O CREA PROGETTO";
                        loginBtn.disabled = false;
                        return; 
                    }
                    await fb.setDoc(projRef, { password: pass, fields: [] });
                }

                currentProjectName = name; currentPassword = pass;
                localStorage.setItem('isolamenti_last_project', JSON.stringify({ name, pass }));
                
                startCloudSync();
                
                document.getElementById('displayProjName').innerText = name.toUpperCase();
                document.getElementById('loginOverlay').classList.add('hidden');
                
                checkAndMigrateLocalData();
            } catch (err) { 
                console.error("Login process error:", err);
                errorEl.innerText = err.message || "Errore di connessione cloud."; 
                errorEl.classList.remove('hidden'); 
                loginBtn.innerText = "ACCEDI O CREA PROGETTO";
                loginBtn.disabled = false;
            }
        };

        function startCloudSync() {
            if (!currentProjectName) return;
            const projRef = fb.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'projects', currentProjectName);
            fb.onSnapshot(projRef, (doc) => {
                if (doc.exists()) {
                    const cloudFields = doc.data().fields || [];
                    const localFieldsSummary = JSON.stringify(fields.map(f => f.id));
                    const cloudFieldsSummary = JSON.stringify(cloudFields.map(f => f.id));
                    if (localFieldsSummary !== cloudFieldsSummary) mergeCloudData(cloudFields);
                }
            }, (err) => {
                console.error("Cloud Sync broken:", err);
                showNotification("Sincronizzazione Cloud persa.");
            });
        }

        function mergeCloudData(cloudData) {
            fields.forEach(f => {
                if(f.marker) map.removeLayer(f.marker); if(f.circle) map.removeLayer(f.circle);
                if(f.polyline) map.removeLayer(f.polyline);
                if(f.checkpoints) f.checkpoints.forEach(cp => { if(cp.marker) map.removeLayer(cp.marker); });
            });
            fields = [];
            cloudData.forEach(fData => addFieldToMap(fData));
            updateFieldUI();
        }

        async function saveToCloud() {
            if (!currentProjectName || isSyncing || !fb.auth.currentUser) return;
            isSyncing = true;
            document.getElementById('syncIndicator').classList.add('animate-pulse');
            
            const cleanFields = fields.map(f => ({
                id: f.id, name: f.name, code: f.code, category: f.category, latlng: f.latlng, radius: f.radius, pathCoords: f.pathCoords,
                checkpoints: (f.checkpoints || []).map(cp => ({ id: cp.id, latlng: cp.latlng, note: cp.note, date: cp.date }))
            }));

            try {
                const projRef = fb.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'projects', currentProjectName);
                await fb.setDoc(projRef, { password: currentPassword, fields: cleanFields }, { merge: true });
                document.getElementById('syncIndicator').className = "text-green-500";
            } catch (err) { 
                console.error("Save error:", err);
                document.getElementById('syncIndicator').className = "text-red-500"; 
            } finally { 
                isSyncing = false; 
                document.getElementById('syncIndicator').classList.remove('animate-pulse'); 
            }
        }

        function checkAndMigrateLocalData() {
            const localRaw = localStorage.getItem('isolamenti_agricoli_v4');
            if (localRaw) {
                try {
                    const localData = JSON.parse(localRaw);
                    if (localData && localData.length > 0) {
                        if (confirm(`Trovati ${localData.length} campi salvati ieri. Caricarli nel Cloud?`)) {
                            fields = [...fields, ...localData];
                            saveToCloud().then(() => localStorage.removeItem('isolamenti_agricoli_v4'));
                        }
                    }
                } catch(e) {}
            }
        }

        // MAP & UI LOGIC
        window.recenterOnUser = function() {
            if (userMarker) map.flyTo(userMarker.getLatLng(), 17);
            else showNotification("GPS non attivo.");
        };

        window.logoutProject = function() {
            if (confirm("Vuoi uscire da questo progetto?")) {
                localStorage.removeItem('isolamenti_last_project');
                location.reload();
            }
        };

        window.handleSearch = function() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!query) return; 
            const f = fields.find(f => (f.name && f.name.toLowerCase().includes(query)) || (f.code && f.code.toLowerCase().includes(query)));
            if (f) { map.flyTo(f.latlng, 15); f.marker.openPopup(); expandPanel(); }
        };

        window.toggleTracking = function() {
            const btn = document.getElementById('trackBtn');
            const tele = document.getElementById('telemetryPanel');
            if (isTracking) {
                if (watchId !== null) navigator.geolocation.clearWatch(watchId);
                watchId = null; isTracking = false;
                btn.innerHTML = '<i data-lucide="navigation" class="w-4 h-4"></i> Attiva GPS';
                btn.classList.replace('bg-rose-600', 'bg-slate-900');
                tele.classList.add('hidden');
                if(userMarker) map.removeLayer(userMarker);
                resetGlobalStatus();
            } else {
                showNotification("Aggancio GPS...");
                watchId = navigator.geolocation.watchPosition((pos) => {
                    document.getElementById('accuracyVal').innerText = pos.coords.accuracy.toFixed(0) + "m";
                    const latlng = L.latLng(pos.coords.latitude, pos.coords.longitude);
                    if (!userMarker) {
                        userMarker = L.marker(latlng, { icon: L.divIcon({ className: 'pulse-user', iconSize: [18, 18], iconAnchor: [9, 9] }) }).addTo(map);
                        map.flyTo(latlng, 15);
                    } else userMarker.setLatLng(latlng);
                    updateGeofencing(latlng);
                }, (err) => showNotification("Errore GPS"), { enableHighAccuracy: true });
                isTracking = true; tele.classList.remove('hidden');
                btn.innerHTML = '<i data-lucide="square" class="w-4 h-4"></i> Ferma GPS';
                btn.classList.replace('bg-slate-900', 'bg-rose-600');
            }
            lucide.createIcons();
        };

        // UI Helpers
        function showNotification(text) {
            const el = document.getElementById('notification'); document.getElementById('notifText').innerText = text;
            el.classList.replace('opacity-0', 'opacity-100'); el.classList.replace('-translate-y-24', 'translate-y-0');
            setTimeout(() => { el.classList.replace('opacity-100', 'opacity-0'); el.classList.replace('translate-y-0', '-translate-y-24'); }, 3000);
        }

        window.openManualCoordModal = () => openFieldModal(true);
        window.closeFieldModal = () => document.getElementById('fieldModal').classList.replace('flex', 'hidden');
        window.closeCheckpointModal = () => { document.getElementById('checkpointModal').classList.replace('flex', 'hidden'); document.getElementById('checkpointNoteInput').value = ""; };
        window.closeActionChoiceModal = () => document.getElementById('actionChoiceModal').classList.replace('flex', 'hidden');
        
        window.selectNewField = () => { closeActionChoiceModal(); openFieldModal(false); };
        window.selectNewCheckpoint = () => { closeActionChoiceModal(); document.getElementById('checkpointModal').classList.replace('hidden', 'flex'); document.getElementById('checkpointNoteInput').focus(); };

        function openFieldModal(isManual = false) { 
            document.getElementById('fieldModal').classList.replace('hidden', 'flex'); 
            document.getElementById('coordsInputs').classList.toggle('hidden', !isManual);
            document.getElementById('fieldNameInput').focus(); 
        }

        window.confirmAddField = function() {
            const name = document.getElementById('fieldNameInput').value.trim() || "Campo";
            const code = document.getElementById('fieldCodeInput').value.trim() || "COD";
            const category = document.getElementById('fieldCategoryInput').value;
            const radius = parseInt(document.getElementById('fieldRadiusInput').value) || 1000;
            let latlng = tempFieldCoords;
            if(!latlng) {
                const lat = parseFloat(document.getElementById('fieldLatInput').value);
                const lon = parseFloat(document.getElementById('fieldLonInput').value);
                if(isNaN(lat)) return; latlng = L.latLng(lat, lon);
            }
            addFieldToMap({ id: Date.now(), name, code, category, latlng, radius, pathCoords: [], checkpoints: [] });
            closeFieldModal(); saveToCloud();
        };

        window.confirmAddCheckpoint = function() {
            const note = document.getElementById('checkpointNoteInput').value.trim(); if (!note) return;
            const field = fields.find(f => f.id === tempCheckpointCoords.fieldId);
            if (field) {
                const cpData = { id: Date.now(), latlng: tempCheckpointCoords.latlng, note, date: new Date().toLocaleString('it-IT') };
                if (!field.checkpoints) field.checkpoints = [];
                field.checkpoints.push(cpData); renderCheckpointOnMap(cpData);
                closeCheckpointModal(); saveToCloud();
            }
        };

        function addFieldToMap(fData) {
            const colors = { cipolle: '#f97316', bunching: '#22c55e', brassiche: '#a855f7' };
            const color = colors[fData.category];
            const marker = L.marker(fData.latlng, { icon: L.divIcon({ html: `<div style="background: ${color}; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border: 3px solid white; shadow: 0 4px 6px rgba(0,0,0,0.2);"><i data-lucide="sprout" style="width: 14px; height: 14px;"></i></div>`, className: '', iconSize: [32, 32], iconAnchor: [16, 16] }) }).addTo(map);
            marker.bindPopup(`<div class="text-xs"><b>${fData.name}</b><br>${fData.code}</div>`);
            const circle = L.circle(fData.latlng, { radius: fData.radius, color, fillOpacity: 0.1, dashArray: '8, 8' }).addTo(map);
            const polyline = L.polyline(fData.pathCoords || [], { color: '#000000', weight: 2, opacity: 0.8, dashArray: '5, 10' }).addTo(map);
            const field = { ...fData, marker, circle, polyline };
            fields.push(field);
            if (field.checkpoints) field.checkpoints.forEach(renderCheckpointOnMap);
            lucide.createIcons();
        }

        function renderCheckpointOnMap(cp) {
            const triangleSVG = `<svg viewBox="0 0 24 24" width="20" height="20"><path d="M12 2 L22 21 L2 21 Z" fill="#ef4444" stroke="#ffffff" stroke-width="2.5"/></svg>`;
            const cpMarker = L.marker(cp.latlng, { icon: L.divIcon({ html: triangleSVG, className: '', iconSize: [20, 20], iconAnchor: [10, 20] }) }).addTo(map);
            cpMarker.bindPopup(`<div class="text-[10px]"><b>RILEVAMENTO</b><br>${cp.date}<br><br>${cp.note}</div>`);
            cp.marker = cpMarker;
        }

        function updateGeofencing(userPos) {
            let anyInside = false; let updated = false;
            fields.forEach(field => {
                const isInside = userPos.distanceTo(field.latlng) <= field.radius;
                if (isInside) {
                    anyInside = true; field.circle.setStyle({ fillOpacity: 0.3, dashArray: '' });
                    if (!field.pathCoords) field.pathCoords = [];
                    field.pathCoords.push([userPos.lat, userPos.lng]); field.polyline.setLatLngs(field.pathCoords);
                    updated = true;
                } else field.circle.setStyle({ fillOpacity: 0.05, dashArray: '8, 8' });
            });
            const statusDot = document.getElementById('statusDot');
            statusDot.className = anyInside ? "w-2.5 h-2.5 rounded-full bg-green-500 animate-pulse" : "w-2.5 h-2.5 rounded-full bg-slate-400";
            document.getElementById('statusText').innerText = anyInside ? "In Area" : "Monitoraggio...";
            if (updated) saveToCloud();
        }

        function resetGlobalStatus() { document.getElementById('statusText').innerText = "GPS Off"; document.getElementById('statusDot').className = "w-2.5 h-2.5 rounded-full bg-slate-400"; fields.forEach(f => f.circle.setStyle({ fillOpacity: 0.1, dashArray: '8, 8' })); }

        function updateFieldUI() {
            const categories = ['cipolle', 'bunching', 'brassiche']; let total = 0;
            categories.forEach(cat => {
                const section = document.getElementById(`cat-${cat}`); const list = document.getElementById(`list-${cat}`);
                const catFields = fields.filter(f => f.category === cat);
                if (catFields.length > 0) {
                    section.classList.remove('hidden'); list.innerHTML = "";
                    catFields.forEach(f => {
                        total++; const item = document.createElement('div');
                        item.className = "flex items-center gap-3 p-3 bg-white border rounded-2xl shadow-sm active:scale-[0.98]";
                        item.onclick = () => { map.flyTo(f.latlng, 15); f.marker.openPopup(); };
                        item.innerHTML = `<div class="w-10 h-10 rounded-xl bg-slate-50 flex flex-col items-center justify-center shrink-0 border"><i data-lucide="map" class="w-4 h-4 text-slate-400"></i><span class="text-[7px] font-bold text-slate-300 mt-1 uppercase">${cat.substring(0,3)}</span></div><div class="flex-1 min-w-0"><p class="text-[11px] font-black text-slate-800 uppercase leading-none truncate">${f.name}</p><p class="text-[9px] font-mono text-slate-400 mt-1">${f.code}</p></div><button onclick="event.stopPropagation(); deleteField(${f.id})" class="p-2 text-slate-200 hover:text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                        list.appendChild(item);
                    });
                } else section.classList.add('hidden');
            });
            document.getElementById('emptyMsg').classList.toggle('hidden', total > 0); lucide.createIcons();
        }

        window.deleteField = function(id) { if (confirm(`Eliminare il campo?`)) { fields = fields.filter(f => f.id !== id); saveToCloud(); } };

        // Inizializzazione Mappa
        function initMap() {
            map = L.map('map', { zoomControl: false, tap: false }).setView([44.5, 11.5], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);
            L.control.zoom({ position: 'topright' }).addTo(map);
            
            map.on('click', function(e) {
                if (!currentProjectName) return;
                let targetField = fields.find(f => e.latlng.distanceTo(f.latlng) <= f.radius);
                if (targetField) { 
                    tempFieldCoords = e.latlng; 
                    tempCheckpointCoords = { latlng: e.latlng, fieldId: targetField.id }; 
                    openActionChoiceModal(); 
                } else { 
                    tempFieldCoords = e.latlng; openFieldModal(false); 
                }
            });

            const saved = localStorage.getItem('isolamenti_last_project');
            if (saved) { 
                try { 
                    const { name, pass } = JSON.parse(saved); 
                    document.getElementById('projectInput').value = name; 
                    document.getElementById('passwordInput').value = pass; 
                    // Attendiamo che window.fbReady sia true prima del login automatico
                    const checkFb = setInterval(() => {
                        if (window.fbReady) {
                            window.handleLogin();
                            clearInterval(checkFb);
                        }
                    }, 500);
                    setTimeout(() => clearInterval(checkFb), 5000); // Timeout sicurezza
                } catch(e) {} 
            }
            lucide.createIcons();
        }

        // Pannello Trascinabile
        const panel = document.getElementById('statusPanel');
        const dragArea = document.getElementById('dragArea');
        const content = document.getElementById('panelContent');
        let startY, currentTranslateY = 0, isDragging = false;

        dragArea.addEventListener('touchstart', (e) => { startY = e.touches[0].clientY; isDragging = true; panel.style.transition = 'none'; }, {passive: true});
        window.addEventListener('touchmove', (e) => { if (!isDragging) return; const move = Math.max(0, e.touches[0].clientY - startY + currentTranslateY); if (move <= panel.offsetHeight - 85) panel.style.transform = `translateY(${move}px)`; }, {passive: true});
        window.addEventListener('touchend', (e) => { if (!isDragging) return; isDragging = false; panel.style.transition = 'transform 0.3s'; const deltaY = e.changedTouches[0].clientY - startY; if (deltaY > 50) minimizePanel(); else if (deltaY < -50) expandPanel(); else panel.style.transform = `translateY(${currentTranslateY}px)`; });
        
        function minimizePanel() { currentTranslateY = panel.offsetHeight - 85; panel.style.transform = `translateY(${currentTranslateY}px)`; content.style.opacity = '0.4'; }
        function expandPanel() { currentTranslateY = 0; panel.style.transform = `translateY(0px)`; content.style.opacity = '1'; }

        // Start
        window.addEventListener('load', initMap);
    </script>
</body>
</html>