<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Isolamenti Agricoli - Cloud & Auto-GPS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        #map { height: calc(100vh - 80px); width: 100%; z-index: 1; background: #cbd5e1; }
        .custom-popup .leaflet-popup-content-wrapper { border-radius: 12px; padding: 8px; }
        
        /* MARKER GPS: Punto blu pulsante ultra-visibile */
        .gps-marker-container {
            display: flex !important; align-items: center; justify-content: center;
            width: 44px !important; height: 44px !important;
        }
        .gps-dot {
            width: 20px !important; height: 20px !important; 
            background: #2563eb !important; border: 3px solid white !important; border-radius: 50%;
            box-shadow: 0 0 15px rgba(0,0,0,0.6);
            position: relative; z-index: 10;
        }
        .gps-radar {
            position: absolute; width: 50px; height: 50px;
            border-radius: 50%; background: rgba(37, 99, 235, 0.4);
            animation: radar-pulse 2s ease-out infinite;
            z-index: 1;
        }
        @keyframes radar-pulse { 0% { transform: scale(0.2); opacity: 1; } 100% { transform: scale(1.8); opacity: 0; } }

        #statusPanel { transition: transform 0.4s cubic-bezier(0.17, 0.67, 0.83, 0.67); touch-action: none; padding-bottom: env(safe-area-inset-bottom); }
        .drag-handle { width: 40px; height: 5px; background-color: #cbd5e1; border-radius: 10px; margin: 0 auto 10px auto; }
        
        #loginOverlay {
            position: fixed; inset: 0; background: #f8fafc; z-index: 9999;
            display: flex; align-items: center; justify-content: center; padding: 20px;
            overflow-y: auto;
        }

        .loader {
            border: 3px solid #f3f3f3; border-top: 3px solid #16a34a;
            border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite;
            display: inline-block; vertical-align: middle; margin-right: 8px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 font-sans overflow-hidden">

    <!-- SCHERMATA DI ACCESSO -->
    <div id="loginOverlay">
        <div class="bg-white p-6 sm:p-8 rounded-[32px] shadow-2xl w-full max-w-md space-y-6 my-auto border border-slate-100">
            <div class="text-center space-y-2">
                <div class="bg-blue-100 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="shield-check" class="text-blue-600 w-8 h-8"></i>
                </div>
                <h1 class="text-2xl font-black text-slate-800 tracking-tight">Accesso Isolamenti</h1>
                <p class="text-slate-500 text-sm italic leading-tight">Progetto Cloud: isolamenti-923d0</p>
            </div>
            
            <div class="space-y-4">
                <div class="bg-slate-50 p-4 rounded-2xl space-y-3 border border-slate-100">
                    <input type="text" id="projectInput" placeholder="ID Gruppo (Team)" class="w-full border border-slate-200 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 bg-white shadow-sm">
                    <input type="password" id="passwordInput" placeholder="Password" class="w-full border border-slate-200 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 bg-white shadow-sm">
                    <button onclick="handleLogin()" id="loginBtn" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold text-sm shadow-lg shadow-blue-100 active:scale-95 transition-all">
                        <span id="btnLabel">ACCEDI AL CLOUD</span>
                    </button>
                </div>

                <div class="relative flex items-center py-1">
                    <div class="flex-grow border-t border-slate-200"></div>
                    <span class="flex-shrink mx-4 text-slate-400 text-[10px] font-bold uppercase">Recupero</span>
                    <div class="flex-grow border-t border-slate-200"></div>
                </div>

                <button onclick="handleLocalMode()" class="w-full bg-slate-800 text-white py-4 rounded-xl font-bold text-sm shadow-xl active:scale-95 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="smartphone" class="w-4 h-4"></i>
                    MODALITÀ LOCALE (RECUPERA PUNTI)
                </button>
            </div>
            <p id="loginError" class="text-red-500 text-[11px] text-center font-bold hidden px-4 leading-tight bg-red-50 py-2 rounded-lg mt-4"></p>
        </div>
    </div>

    <!-- INTERFACCIA PRINCIPALE -->
    <header class="bg-white shadow-md p-4 sticky top-0 z-50 border-b border-slate-100 h-[80px]">
        <div class="max-w-6xl mx-auto flex items-center gap-4">
            <div class="flex items-center gap-2 shrink-0">
                <div class="bg-green-600 p-2 rounded-lg">
                    <i data-lucide="sprout" class="text-white w-5 h-5"></i>
                </div>
                <div class="hidden sm:block">
                    <h1 class="text-lg font-bold text-slate-800 leading-none" id="displayProjName">Isolamenti</h1>
                    <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400" id="syncStatusLabel">Offline</span>
                </div>
            </div>
            
            <div class="flex-1 flex gap-2">
                <div class="relative flex-1">
                    <i data-lucide="search" class="absolute left-3 top-3 text-slate-400 w-4 h-4"></i>
                    <input type="text" id="searchInput" placeholder="Cerca punto..." class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-slate-50">
                </div>
                <button onclick="handleSearch()" class="bg-blue-600 text-white px-4 py-2 rounded-xl font-semibold active:scale-95">Trova</button>
            </div>
        </div>
    </header>

    <main class="relative">
        <div id="map"></div>

        <div class="absolute top-4 left-4 z-[1000] flex flex-col gap-2">
            <button onclick="recenterOnUser()" class="bg-white p-3 rounded-xl shadow-lg text-slate-700 active:scale-90 border border-slate-100">
                <i data-lucide="locate-fixed" class="w-5 h-5"></i>
            </button>
            <button onclick="openManualCoordModal()" class="bg-white p-3 rounded-xl shadow-lg text-slate-700 active:scale-90 border border-slate-100">
                <i data-lucide="map-pin" class="w-5 h-5"></i>
            </button>
        </div>

        <div id="telemetryPanel" class="absolute top-4 right-4 z-[1000] hidden">
            <div class="bg-white/90 backdrop-blur px-3 py-2 rounded-xl shadow-lg border border-slate-100 text-[10px] font-bold text-slate-600 flex items-center gap-2">
                <div class="flex flex-col"><span class="text-slate-400 uppercase tracking-tighter">Segnale GPS</span><span id="accuracyVal">--m</span></div>
                <div id="syncIndicator" class="text-slate-400"><i data-lucide="cloud-check" class="w-4 h-4"></i></div>
            </div>
        </div>

        <!-- PANNELLO INFERIORE -->
        <div id="statusPanel" class="absolute bottom-0 left-0 right-0 bg-white shadow-[0_-10px_40px_-5px_rgba(0,0,0,0.15)] rounded-t-[32px] p-5 z-[1000] border-t border-slate-200 max-h-[85vh] flex flex-col translate-y-[calc(100%-85px)]">
            <div id="dragArea" class="cursor-grab active:cursor-grabbing pb-4 -mt-2 shrink-0">
                <div class="drag-handle"></div>
                <div class="flex items-center justify-between">
                    <span class="text-[10px] font-black uppercase tracking-widest text-slate-500">I Miei Punti</span>
                    <div id="statusIndicator" class="flex items-center gap-2 px-3 py-1 rounded-full text-[10px] font-bold bg-slate-100 text-slate-600 transition-all">
                        <span id="statusDot" class="w-2.5 h-2.5 rounded-full bg-slate-400"></span>
                        <span id="statusText">GPS Off</span>
                    </div>
                </div>
            </div>

            <div id="panelContent" class="space-y-6 overflow-y-auto flex-1 pb-6 opacity-40">
                <div class="flex gap-2">
                    <button id="trackBtn" onclick="toggleTracking()" class="flex-1 flex items-center justify-center gap-2 bg-slate-900 text-white py-3.5 rounded-xl font-bold active:scale-95 shadow-md transition-all">
                        <i data-lucide="navigation" class="w-4 h-4"></i> Attiva GPS
                    </button>
                    <button onclick="logoutProject()" class="bg-slate-100 text-slate-500 p-3.5 rounded-xl hover:bg-slate-200">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </div>

                <div id="fieldsSection" class="space-y-6">
                    <div id="cat-cipolle" class="hidden">
                        <div class="flex items-center gap-2 mb-3"><div class="w-1 h-4 bg-orange-500 rounded-full"></div><h3 class="text-xs font-black uppercase text-slate-600 tracking-wider">Cipolle</h3></div>
                        <div id="list-cipolle" class="space-y-2"></div>
                    </div>
                    <div id="cat-bunching" class="hidden">
                        <div class="flex items-center gap-2 mb-3"><div class="w-1 h-4 bg-green-500 rounded-full"></div><h3 class="text-xs font-black uppercase text-slate-600 tracking-wider">Bunching</h3></div>
                        <div id="list-bunching" class="space-y-2"></div>
                    </div>
                    <div id="cat-brassiche" class="hidden">
                        <div class="flex items-center gap-2 mb-3"><div class="w-1 h-4 bg-purple-500 rounded-full"></div><h3 class="text-xs font-black uppercase text-slate-600 tracking-wider">Brassiche</h3></div>
                        <div id="list-brassiche" class="space-y-2"></div>
                    </div>
                    <div id="emptyMsg" class="text-center py-10 text-slate-400 text-xs italic">Nessun punto registrato.</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="actionChoiceModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-[2000] p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl text-center animate-in zoom-in duration-200">
            <h2 class="text-lg font-bold text-slate-800 mb-6 tracking-tight">Nuovo Rilevamento</h2>
            <div class="flex flex-col gap-4">
                <button onclick="selectNewField()" class="flex items-center justify-between bg-green-50 text-green-700 p-4 rounded-2xl border border-green-200 active:scale-95">
                    <div class="flex items-center gap-3"><i data-lucide="plus-circle" class="w-6 h-6"></i><span class="font-bold">Crea Isolamento</span></div>
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                </button>
                <button onclick="selectNewCheckpoint()" class="flex items-center justify-between bg-blue-50 text-blue-700 p-4 rounded-2xl border border-blue-200 active:scale-95">
                    <div class="flex items-center gap-3"><i data-lucide="clipboard-check" class="w-6 h-6"></i><span class="font-bold">Aggiungi Nota</span></div>
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                </button>
                <button onclick="closeActionChoiceModal()" class="mt-2 text-slate-400 text-sm font-bold">Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal Form -->
    <div id="fieldModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-[2000] p-4">
        <div class="bg-white rounded-3xl w-full max-w-md p-6 shadow-2xl animate-in zoom-in duration-200">
            <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2 text-green-700"><i data-lucide="plus-circle"></i> Registra Isolamento</h2>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="fieldNameInput" placeholder="Nome Campo" class="w-full border border-slate-200 rounded-xl p-3 text-sm bg-slate-50 outline-none focus:ring-2 focus:ring-green-500">
                    <input type="text" id="fieldCodeInput" placeholder="Codice" class="w-full border border-slate-200 rounded-xl p-3 text-sm bg-slate-50 outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <select id="fieldCategoryInput" class="w-full border border-slate-200 rounded-xl p-3 text-sm bg-slate-50 outline-none focus:ring-2 focus:ring-green-500">
                    <option value="cipolle">Cipolle</option>
                    <option value="bunching">Bunching</option>
                    <option value="brassiche">Brassiche</option>
                </select>
                <div id="coordsInputs" class="hidden grid grid-cols-2 gap-3">
                    <input type="number" id="fieldLatInput" step="any" placeholder="Lat" class="w-full border border-slate-200 rounded-xl p-3 text-sm bg-slate-50 outline-none">
                    <input type="number" id="fieldLonInput" step="any" placeholder="Lon" class="w-full border border-slate-200 rounded-xl p-3 text-sm bg-slate-50 outline-none">
                </div>
                <input type="number" id="fieldRadiusInput" value="1000" placeholder="Raggio (metri)" class="w-full border border-slate-200 rounded-xl p-3 text-sm bg-slate-50 outline-none">
                <div class="flex gap-3 pt-2">
                    <button onclick="closeFieldModal()" class="flex-1 py-3.5 border border-slate-200 rounded-xl font-bold text-slate-400">Annulla</button>
                    <button onclick="confirmAddField()" class="flex-1 py-3.5 bg-green-600 text-white rounded-xl font-bold">REGISTRA</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script Unificato -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const myFirebaseConfig = {
          apiKey: "AIzaSyCOmo-r782E20Sq7sLKUqGnTFK9zLb4OoE",
          authDomain: "isolamenti-923d0.firebaseapp.com",
          projectId: "isolamenti-923d0",
          storageBucket: "isolamenti-923d0.firebasestorage.app",
          messagingSenderId: "907661900494",
          appId: "1:907661900494:web:dbb5c4a4235ee2ada3ae9f",
          measurementId: "G-DQ37WPPJ42"
        };

        let fb = {};
        let map, userMarker, watchId = null, fields = []; 
        let isTracking = false, tempFieldCoords = null, tempCheckpointCoords = null;
        let currentProjectName = null, currentPassword = null;
        let isLocalMode = false;
        let mapReady = false;

        async function initFirebase() {
            try {
                const app = initializeApp(myFirebaseConfig);
                fb.auth = getAuth(app);
                fb.db = getFirestore(app);
                fb.appId = 'isolamenti-923d0';
                fb.loginAnon = () => signInAnonymously(fb.auth);
                fb.loginToken = (t) => signInWithCustomToken(fb.auth, t);
                window.fbReady = true;
                return true;
            } catch (e) { return false; }
        }

        window.handleLogin = async function() {
            const loginBtn = document.getElementById('loginBtn');
            const btnLabel = document.getElementById('btnLabel');
            const errorEl = document.getElementById('loginError');
            const nameRaw = document.getElementById('projectInput').value.trim();
            const pass = document.getElementById('passwordInput').value.trim();
            
            if (!nameRaw || !pass) { errorEl.innerText = "Dati mancanti."; errorEl.classList.remove('hidden'); return; }
            loginBtn.disabled = true; document.getElementById('btnLabel').innerHTML = '<span class="loader"></span> AUTH...';
            errorEl.classList.add('hidden');
            
            try {
                if (!window.fbReady) await initFirebase();
                const authPromise = (async () => {
                    const customToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (customToken) await fb.loginToken(customToken); else await fb.loginAnon();
                    return fb.auth.currentUser;
                })();
                const authTimeout = new Promise((_, r) => setTimeout(() => r(new Error("Timeout Google Cloud.")), 15000));
                const user = await Promise.race([authPromise, authTimeout]);
                
                const name = nameRaw.toLowerCase().replace(/[^a-z0-9_]/g, ''); 
                const projRef = doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'projects', name);
                const docSnap = await getDoc(projRef);

                if (docSnap.exists() && docSnap.data().password !== pass) throw new Error("Password errata.");
                if (!docSnap.exists()) await setDoc(projRef, { password: pass, fields: [] });

                enterApp(name, pass, false);
            } catch (err) { 
                errorEl.innerText = err.message; errorEl.classList.remove('hidden'); 
                loginBtn.disabled = false; document.getElementById('btnLabel').innerText = "ACCEDI AL CLOUD";
            }
        };

        window.handleLocalMode = function() {
            enterApp("LOCALE", "", true);
        };

        function enterApp(name, pass, local) {
            isLocalMode = local; 
            currentProjectName = name; currentPassword = pass;
            localStorage.setItem('isolamenti_last_session', JSON.stringify({ mode: local ? 'local' : 'cloud', name, pass }));
            
            document.getElementById('syncStatusLabel').innerText = local ? "Sola Smartphone" : "Cloud Attivo";
            document.getElementById('displayProjName').innerText = name.toUpperCase();
            document.getElementById('loginOverlay').style.display = 'none';
            
            // Ciclo di attesa per sicurezza mappa
            const checkMap = setInterval(() => {
                if (mapReady) {
                    if (local) loadForensicData();
                    else startCloudSync();
                    checkAndMigrateLegacyData();
                    setTimeout(() => toggleTracking(true), 500);
                    clearInterval(checkMap);
                }
            }, 300);
        }

        // --- RECUPERO "FORENSE" (SCANSIONE TOTALE) ---
        function loadForensicData() {
            let recovered = [];
            const seenIds = new Set();
            
            // 1. Controlla ogni singola voce del localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                try {
                    const raw = localStorage.getItem(key);
                    const data = JSON.parse(raw);
                    
                    // Se è un array di punti
                    if (Array.isArray(data)) {
                        data.forEach(item => {
                            if ((item.latlng || (item.lat && item.lng)) && !seenIds.has(item.id || item.name)) {
                                if (!item.latlng) item.latlng = [item.lat, item.lng];
                                recovered.push(item);
                                seenIds.add(item.id || item.name);
                            }
                        });
                    } 
                    // Se è un singolo punto salvato individualmente
                    else if (data && typeof data === 'object' && (data.latlng || (data.lat && data.lng))) {
                        if (!seenIds.has(data.id || data.name)) {
                            if (!data.latlng) data.latlng = [data.lat, data.lng];
                            recovered.push(data);
                            seenIds.add(data.id || data.name);
                        }
                    }
                } catch(e){}
            }

            if (recovered.length > 0) {
                mergeData(recovered);
                localStorage.setItem('isolamenti_local_db', JSON.stringify(recovered));
                showNotification(`Recuperati ${recovered.length} punti dalla memoria.`);
                
                // Centra la mappa sui punti recuperati
                const bounds = recovered.map(f => f.latlng);
                if (bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50] });
            } else {
                showNotification("Nessun punto trovato sul dispositivo.");
            }
        }

        function checkAndMigrateLegacyData() {
            if (isLocalMode) return;
            const raw = localStorage.getItem('isolamenti_local_db');
            if (raw) {
                const data = JSON.parse(raw);
                if (data.length > 0 && confirm(`Trovati ${data.length} punti locali. Caricarli nel Cloud di squadra?`)) {
                    fields = [...fields, ...data]; saveData();
                    localStorage.removeItem('isolamenti_local_db');
                }
            }
        }

        function startCloudSync() {
            const projRef = doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'projects', currentProjectName);
            onSnapshot(projRef, (doc) => {
                if (doc.exists()) {
                    const cloudFields = doc.data().fields || [];
                    mergeData(cloudFields);
                }
            });
        }

        function mergeData(newData) {
            if (!mapReady) return;
            fields.forEach(f => {
                if(f.marker) map.removeLayer(f.marker); if(f.circle) map.removeLayer(f.circle);
                if(f.polyline) map.removeLayer(f.polyline);
                if(f.checkpoints) f.checkpoints.forEach(cp => { if(cp.marker) map.removeLayer(cp.marker); });
            });
            fields = []; 
            newData.forEach(fData => {
                if (fData.latlng && typeof fData.latlng === 'object' && !Array.isArray(fData.latlng)) {
                    fData.latlng = [fData.latlng.lat, fData.latlng.lng];
                }
                addFieldToMap(fData);
            }); 
            updateFieldUI();
            map.invalidateSize();
        }

        async function saveData() {
            const clean = fields.map(f => ({ id: f.id, name: f.name, code: f.code, category: f.category, latlng: f.latlng, radius: f.radius, pathCoords: f.pathCoords || [], checkpoints: (f.checkpoints || []).map(cp => ({ id: cp.id, latlng: cp.latlng, note: cp.note, date: cp.date })) }));
            if (isLocalMode) {
                localStorage.setItem('isolamenti_local_db', JSON.stringify(clean));
            } else if (fb.auth?.currentUser) {
                try {
                    const projRef = doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'projects', currentProjectName);
                    await setDoc(projRef, { password: currentPassword, fields: clean }, { merge: true });
                    document.getElementById('syncIndicator').className = "text-green-600 font-black";
                } catch (e) { console.error(e); }
            }
        }

        // --- GPS E UI ---
        window.recenterOnUser = () => { if (userMarker) map.flyTo(userMarker.getLatLng(), 17); else showNotification("GPS non pronto."); };
        window.logoutProject = () => { if (confirm("Uscire?")) { localStorage.removeItem('isolamenti_last_session'); location.reload(); } };
        
        window.handleSearch = () => {
            const q = document.getElementById('searchInput').value.trim().toLowerCase(); 
            if (!q) return;
            const f = fields.find(f => (f.name && f.name.toLowerCase().includes(q)) || (f.code && f.code.toLowerCase().includes(q)));
            if (f) { map.flyTo(f.latlng, 15); f.marker.openPopup(); expandPanel(); }
        };

        window.toggleTracking = (auto = false) => {
            const btn = document.getElementById('trackBtn'); 
            const tele = document.getElementById('telemetryPanel');
            
            if (isTracking && !auto) {
                if (watchId !== null) navigator.geolocation.clearWatch(watchId);
                watchId = null; isTracking = false;
                btn.innerHTML = '<i data-lucide="navigation" class="w-4 h-4"></i> Attiva GPS';
                btn.classList.replace('bg-rose-600', 'bg-slate-900'); tele.classList.add('hidden');
                if(userMarker) { map.removeLayer(userMarker); userMarker = null; }
                resetGlobalStatus();
            } else if (!isTracking) {
                btn.innerHTML = '<span class="loader"></span> GPS...';
                
                watchId = navigator.geolocation.watchPosition((pos) => {
                    const latlng = L.latLng(pos.coords.latitude, pos.coords.longitude);
                    document.getElementById('accuracyVal').innerText = pos.coords.accuracy.toFixed(0) + "m";
                    
                    if (!userMarker) { 
                        // MARKER POSIZIONE ULTRA-VISIBILE
                        userMarker = L.marker(latlng, { 
                            icon: L.divIcon({ 
                                className: 'gps-marker-container', 
                                html: '<div class="gps-radar"></div><div class="gps-dot"></div>', 
                                iconSize: [44, 44], iconAnchor: [22, 22] 
                            }),
                            zIndexOffset: 10000 
                        }).addTo(map); 
                        map.flyTo(latlng, 17); 
                    } else {
                        userMarker.setLatLng(latlng);
                    }
                    
                    updateGeofencing(latlng);
                    isTracking = true; 
                    tele.classList.remove('hidden');
                    btn.innerHTML = '<i data-lucide="square" class="w-4 h-4"></i> Stop GPS';
                    btn.classList.replace('bg-slate-900', 'bg-rose-600');
                    lucide.createIcons();
                }, (err) => {
                    if(!auto) showNotification("Permessi GPS necessari.");
                    btn.innerHTML = '<i data-lucide="navigation" class="w-4 h-4"></i> Attiva GPS';
                    isTracking = false;
                }, { enableHighAccuracy: true, timeout: 20000 });
            }
            lucide.createIcons();
        };

        window.openManualCoordModal = () => openFieldModal(true);
        window.closeFieldModal = () => document.getElementById('fieldModal').classList.replace('flex', 'hidden');
        window.closeActionChoiceModal = () => document.getElementById('actionChoiceModal').classList.replace('flex', 'hidden');
        window.selectNewField = () => { closeActionChoiceModal(); openFieldModal(false); };

        function openFieldModal(isManual = false) { 
            document.getElementById('fieldModal').classList.replace('hidden', 'flex'); 
            document.getElementById('coordsInputs').classList.toggle('hidden', !isManual);
            document.getElementById('fieldNameInput').focus(); 
        }

        window.confirmAddField = function() {
            const name = document.getElementById('fieldNameInput').value.trim() || "Senza Nome";
            const code = document.getElementById('fieldCodeInput').value.trim() || "---";
            const category = document.getElementById('fieldCategoryInput').value;
            const radius = parseInt(document.getElementById('fieldRadiusInput').value) || 1000;
            let latlng = tempFieldCoords;
            if(!latlng) { 
                const lat = parseFloat(document.getElementById('fieldLatInput').value); const lon = parseFloat(document.getElementById('fieldLonInput').value); 
                if(isNaN(lat) || isNaN(lon)) return; latlng = L.latLng(lat, lon); 
            }
            const newField = { id: Date.now(), name, code, category, latlng: [latlng.lat, latlng.lng], radius, pathCoords: [], checkpoints: [] };
            fields.push(newField); addFieldToMap(newField); closeFieldModal(); saveData(); updateFieldUI();
        };

        function addFieldToMap(fData) {
            const colors = { cipolle: '#f97316', bunching: '#22c55e', brassiche: '#a855f7' }; 
            const color = colors[fData.category] || '#64748b';
            const marker = L.marker(fData.latlng, { icon: L.divIcon({ html: `<div style="background: ${color}; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.2);"><i data-lucide="sprout" style="width: 14px; height: 14px;"></i></div>`, className: '', iconSize: [32, 32], iconAnchor: [16, 16] }) }).addTo(map);
            const circle = L.circle(fData.latlng, { radius: fData.radius || 1000, color, fillOpacity: 0.1, dashArray: '8, 8' }).addTo(map);
            const polyline = L.polyline(fData.pathCoords || [], { color: '#000000', weight: 2, opacity: 0.8, dashArray: '5, 10' }).addTo(map);
            const idx = fields.findIndex(f => f.id === fData.id);
            if (idx !== -1) { fields[idx].marker = marker; fields[idx].circle = circle; fields[idx].polyline = polyline; }
            else { fields.push({ ...fData, marker, circle, polyline }); }
            lucide.createIcons();
        }

        function updateGeofencing(userPos) {
            let anyInside = false; 
            fields.forEach(field => {
                const dist = userPos.distanceTo(L.latLng(field.latlng));
                if (dist <= field.radius) { 
                    anyInside = true; field.circle.setStyle({ fillOpacity: 0.3, dashArray: '' }); 
                    if (!field.pathCoords) field.pathCoords = [];
                    const last = field.pathCoords[field.pathCoords.length - 1];
                    if (!last || Math.abs(last[0] - userPos.lat) > 0.0001) { field.pathCoords.push([userPos.lat, userPos.lng]); field.polyline.setLatLngs(field.pathCoords); saveData(); }
                } else field.circle.setStyle({ fillOpacity: 0.05, dashArray: '8, 8' });
            });
            document.getElementById('statusDot').className = anyInside ? "w-2.5 h-2.5 rounded-full bg-green-500 animate-pulse" : "w-2.5 h-2.5 rounded-full bg-slate-400";
            document.getElementById('statusText').innerText = anyInside ? "In Area Sicura" : "Monitoraggio...";
        }

        function resetGlobalStatus() { document.getElementById('statusText').innerText = "GPS Off"; document.getElementById('statusDot').className = "w-2.5 h-2.5 rounded-full bg-slate-400"; fields.forEach(f => f.circle.setStyle({ fillOpacity: 0.1, dashArray: '8, 8' })); }

        function updateFieldUI() {
            const categories = ['cipolle', 'bunching', 'brassiche']; let total = 0;
            categories.forEach(cat => {
                const section = document.getElementById(`cat-${cat}`); const list = document.getElementById(`list-${cat}`); const catFields = fields.filter(f => f.category === cat);
                if (catFields.length > 0) {
                    section.classList.remove('hidden'); list.innerHTML = "";
                    catFields.forEach(f => { total++; const item = document.createElement('div'); item.className = "flex items-center gap-3 p-3 bg-white border rounded-2xl shadow-sm active:scale-[0.98]"; item.onclick = () => { map.flyTo(f.latlng, 15); f.marker.openPopup(); }; item.innerHTML = `<div class="w-10 h-10 rounded-xl bg-slate-50 flex flex-col items-center justify-center shrink-0 border"><i data-lucide="map" class="w-4 h-4 text-slate-400"></i><span class="text-[7px] font-bold text-slate-300 mt-1 uppercase">${cat.substring(0,3)}</span></div><div class="flex-1 min-w-0"><p class="text-[11px] font-black text-slate-800 uppercase leading-none truncate">${f.name}</p><p class="text-[9px] font-mono text-slate-400 mt-1">${f.code}</p></div><button onclick="event.stopPropagation(); deleteField(${f.id})" class="p-2 text-slate-200 hover:text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`; list.appendChild(item); });
                } else section.classList.add('hidden');
            });
            document.getElementById('emptyMsg').classList.toggle('hidden', total > 0); lucide.createIcons();
        }

        window.deleteField = function(id) { 
            if (confirm("Vuoi eliminare definitivamente questo punto?")) { 
                const f = fields.find(f => f.id === id);
                if (f) { if(f.marker) map.removeLayer(f.marker); if(f.circle) map.removeLayer(f.circle); if(f.polyline) map.removeLayer(f.polyline); fields = fields.filter(f => f.id !== id); saveData(); updateFieldUI(); }
            } 
        };

        function initMap() {
            map = L.map('map', { zoomControl: false, tap: false }).setView([44.5, 11.5], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);
            L.control.zoom({ position: 'topright' }).addTo(map);
            map.on('click', (e) => { if (!currentProjectName && !isLocalMode) return; let target = fields.find(f => e.latlng.distanceTo(L.latLng(f.latlng)) <= f.radius); if (target) { tempFieldCoords = e.latlng; tempCheckpointCoords = { latlng: e.latlng, fieldId: target.id }; openActionChoiceModal(); } else { tempFieldCoords = e.latlng; openFieldModal(false); } });
            mapReady = true;
            const saved = localStorage.getItem('isolamenti_last_session');
            if (saved) { try { const s = JSON.parse(saved); enterApp(s.name, s.pass, s.mode === 'local'); } catch(e) {} }
            lucide.createIcons();
        }

        const panel = document.getElementById('statusPanel'); const dragArea = document.getElementById('dragArea'); let startY, currentTranslateY = 0, isDragging = false;
        dragArea.addEventListener('touchstart', (e) => { startY = e.touches[0].clientY; isDragging = true; panel.style.transition = 'none'; }, {passive: true});
        window.addEventListener('touchmove', (e) => { if (!isDragging) return; const m = Math.max(0, e.touches[0].clientY - startY + currentTranslateY); if (m <= panel.offsetHeight - 85) panel.style.transform = `translateY(${m}px)`; }, {passive: true});
        window.addEventListener('touchend', (e) => { if (!isDragging) return; isDragging = false; panel.style.transition = 'transform 0.4s'; const dY = e.changedTouches[0].clientY - startY; if (dY > 50) minimizePanel(); else if (dY < -50) expandPanel(); else panel.style.transform = `translateY(${currentTranslateY}px)`; });
        function minimizePanel() { currentTranslateY = panel.offsetHeight - 85; panel.style.transform = `translateY(${currentTranslateY}px)`; document.getElementById('panelContent').style.opacity = '0.4'; }
        function expandPanel() { currentTranslateY = 0; panel.style.transform = `translateY(0px)`; document.getElementById('panelContent').style.opacity = '1'; }
        function showNotification(text) { const el = document.getElementById('notification'); document.getElementById('notifText').innerText = text; el.classList.replace('opacity-0', 'opacity-100'); el.classList.replace('-translate-y-24', 'translate-y-0'); setTimeout(() => { el.classList.replace('opacity-100', 'opacity-0'); el.classList.replace('translate-y-0', '-translate-y-24'); }, 5000); }

        initMap(); initFirebase();
    </script>
</body>
</html>