<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Isolamenti Agricoli - Gestione Avanzata</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        #map { height: calc(100vh - 85px); width: 100%; z-index: 1; }
        .custom-popup .leaflet-popup-content-wrapper { border-radius: 12px; padding: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        .pulse-user {
            width: 18px; height: 18px;
            background: #3b82f6; border: 3px solid white; border-radius: 50%;
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 12px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        #statusPanel {
            transition: transform 0.3s cubic-bezier(0.17, 0.67, 0.83, 0.67);
            touch-action: none; 
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .drag-handle {
            width: 40px; height: 5px;
            background-color: #cbd5e1; border-radius: 10px;
            margin: 0 auto 10px auto;
        }
    </style>
</head>
<body class="bg-slate-50 font-sans overflow-hidden">

    <header class="bg-white shadow-md p-4 sticky top-0 z-50 border-b border-slate-100 h-[80px]">
        <div class="max-w-6xl mx-auto flex items-center gap-4">
            <div class="flex items-center gap-2 shrink-0">
                <div class="bg-green-600 p-2 rounded-lg shadow-md">
                    <i data-lucide="leaf" class="text-white w-5 h-5"></i>
                </div>
                <h1 class="text-xl font-bold text-slate-800 tracking-tight hidden sm:block text-green-700">Isolamenti</h1>
            </div>
            
            <div class="flex-1 flex gap-2">
                <div class="relative flex-1">
                    <i data-lucide="search" class="absolute left-3 top-3 text-slate-400 w-4 h-4"></i>
                    <input type="text" id="searchInput" placeholder="Cerca Nome, Codice o Località..." 
                        class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none text-sm shadow-inner bg-slate-50">
                </div>
                <button onclick="handleSearch()" class="bg-green-600 text-white px-4 py-2 rounded-xl font-semibold hover:bg-green-700 active:scale-95 shadow-lg shadow-green-100 transition-all">
                    Cerca
                </button>
            </div>
        </div>
    </header>

    <main class="relative">
        <div id="map"></div>

        <!-- Bottoni Rapidi -->
        <div class="absolute top-4 left-4 z-[1000] flex flex-col gap-2">
            <button onclick="recenterOnUser()" class="bg-white p-3 rounded-xl shadow-lg hover:bg-slate-50 text-slate-700 border border-slate-100 active:scale-90 transition-transform">
                <i data-lucide="locate-fixed" class="w-5 h-5"></i>
            </button>
            <button onclick="openManualCoordModal()" class="bg-white p-3 rounded-xl shadow-lg hover:bg-slate-50 text-slate-700 border border-slate-100 active:scale-90 transition-transform" title="Inserimento Coordinate">
                <i data-lucide="map-pin" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- Telemetria -->
        <div id="telemetryPanel" class="absolute top-4 right-4 z-[1000] hidden">
            <div class="bg-white/90 backdrop-blur px-3 py-2 rounded-xl shadow-lg border border-slate-100 text-[10px] font-bold text-slate-600 flex items-center gap-2">
                <div class="flex flex-col"><span class="text-slate-400 uppercase tracking-tighter">Precisione</span><span id="accuracyVal">--m</span></div>
            </div>
        </div>

        <!-- BOTTOM SHEET -->
        <div id="statusPanel" class="absolute bottom-0 left-0 right-0 bg-white shadow-[0_-10px_40px_-5px_rgba(0,0,0,0.15)] rounded-t-[32px] p-5 z-[1000] border-t border-slate-200 max-h-[85vh] flex flex-col">
            <div id="dragArea" class="cursor-grab active:cursor-grabbing pb-4 -mt-2 shrink-0">
                <div class="drag-handle"></div>
                <div class="flex items-center justify-between">
                    <span class="text-[10px] font-black uppercase tracking-widest text-slate-500">Gestione Campi Agricoli</span>
                    <div id="statusIndicator" class="flex items-center gap-2 px-3 py-1 rounded-full text-[10px] font-bold bg-slate-100 text-slate-600 transition-colors">
                        <span id="statusDot" class="w-2.5 h-2.5 rounded-full bg-slate-400"></span>
                        <span id="statusText">Inattivo</span>
                    </div>
                </div>
            </div>

            <div id="panelContent" class="space-y-6 overflow-y-auto custom-scrollbar flex-1 pb-6">
                <div id="infoBox" class="space-y-3">
                    <p class="text-xs text-slate-500 leading-tight">Tocca la mappa per aggiungere un nuovo isolamento o una nota di controllo se sei dentro un cerchio.</p>
                    
                    <div class="flex gap-2">
                        <button id="trackBtn" onclick="toggleTracking()" class="flex-1 flex items-center justify-center gap-2 bg-slate-900 text-white py-3 rounded-xl font-bold active:scale-95 shadow-md">
                            <i data-lucide="navigation" class="w-4 h-4"></i> Attiva GPS
                        </button>
                        <div class="flex gap-1">
                            <button onclick="exportData()" class="bg-slate-100 text-slate-600 p-3 rounded-xl hover:bg-slate-200 transition-colors" title="Esporta dati">
                                <i data-lucide="share-2" class="w-5 h-5"></i>
                            </button>
                            <button onclick="importData()" class="bg-slate-100 text-slate-600 p-3 rounded-xl hover:bg-slate-200 transition-colors" title="Importa dati">
                                <i data-lucide="download" class="w-5 h-5"></i>
                            </button>
                            <button onclick="clearAllData()" class="bg-slate-100 text-red-500 p-3 rounded-xl hover:bg-red-50 transition-colors">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Lista Campi Categorizzata -->
                <div id="fieldsSection" class="space-y-6">
                    <div id="cat-cipolle" class="hidden">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-1 h-4 bg-orange-500 rounded-full"></div>
                            <h3 class="text-xs font-black uppercase text-slate-600 tracking-wider">Cipolle</h3>
                        </div>
                        <div id="list-cipolle" class="space-y-2"></div>
                    </div>

                    <div id="cat-bunching" class="hidden">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-1 h-4 bg-green-500 rounded-full"></div>
                            <h3 class="text-xs font-black uppercase text-slate-600 tracking-wider">Bunching</h3>
                        </div>
                        <div id="list-bunching" class="space-y-2"></div>
                    </div>

                    <div id="cat-brassiche" class="hidden">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-1 h-4 bg-purple-500 rounded-full"></div>
                            <h3 class="text-xs font-black uppercase text-slate-600 tracking-wider">Brassiche</h3>
                        </div>
                        <div id="list-brassiche" class="space-y-2"></div>
                    </div>

                    <div id="emptyMsg" class="text-center py-8 text-slate-400 text-xs italic">
                        Nessun campo registrato.
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Scelta Azione -->
    <div id="actionChoiceModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-[2000] p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl animate-in zoom-in duration-200">
            <h2 class="text-lg font-bold text-slate-800 mb-6 text-center">Cosa vuoi fare?</h2>
            <div class="flex flex-col gap-4">
                <button onclick="selectNewField()" class="flex items-center justify-between bg-green-50 hover:bg-green-100 text-green-700 p-4 rounded-2xl border border-green-200 transition-colors group">
                    <div class="flex items-center gap-3">
                        <i data-lucide="plus-circle" class="w-6 h-6"></i>
                        <span class="font-bold">Nuovo Isolamento</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-green-400 group-hover:translate-x-1 transition-transform"></i>
                </button>
                <button onclick="selectNewCheckpoint()" class="flex items-center justify-between bg-blue-50 hover:bg-blue-100 text-blue-700 p-4 rounded-2xl border border-blue-200 transition-colors group">
                    <div class="flex items-center gap-3">
                        <i data-lucide="clipboard-check" class="w-6 h-6"></i>
                        <span class="font-bold">Aggiungi Nota</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-blue-400 group-hover:translate-x-1 transition-transform"></i>
                </button>
                <button onclick="closeActionChoiceModal()" class="mt-2 text-slate-400 text-sm font-bold py-2">Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal Nuovo Campo -->
    <div id="fieldModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-[2000] p-4">
        <div class="bg-white rounded-3xl w-full max-w-md p-6 shadow-2xl animate-in zoom-in duration-200">
            <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2 text-green-700">
                <i data-lucide="plus-circle"></i> Nuovo Isolamento
            </h2>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Nome</label>
                        <input type="text" id="fieldNameInput" class="w-full border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-green-500 outline-none text-sm bg-slate-50" placeholder="es. Campo Nord">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Codice</label>
                        <input type="text" id="fieldCodeInput" class="w-full border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-green-500 outline-none text-sm bg-slate-50" placeholder="es. C-2024">
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Categoria Coltura</label>
                    <select id="fieldCategoryInput" class="w-full border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-green-500 outline-none text-sm bg-slate-50 cursor-pointer">
                        <option value="cipolle">Cipolle</option>
                        <option value="bunching">Bunching</option>
                        <option value="brassiche">Brassiche</option>
                    </select>
                </div>

                <div id="coordsInputs" class="hidden space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Latitudine</label>
                            <input type="number" id="fieldLatInput" step="any" class="w-full border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-green-500 outline-none text-sm bg-slate-50">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Longitudine</label>
                            <input type="number" id="fieldLonInput" step="any" class="w-full border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-green-500 outline-none text-sm bg-slate-50">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Raggio Isolamento (m)</label>
                    <input type="number" id="fieldRadiusInput" value="1000" class="w-full border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-green-500 outline-none text-sm bg-slate-50">
                </div>

                <div class="flex gap-3 pt-2">
                    <button onclick="closeFieldModal()" class="flex-1 py-3 border border-slate-200 rounded-xl font-bold text-slate-500 text-sm">Annulla</button>
                    <button onclick="confirmAddField()" class="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold text-sm shadow-lg shadow-green-200">Registra Campo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nuovo Checkpoint -->
    <div id="checkpointModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-[2000] p-4">
        <div class="bg-white rounded-3xl w-full max-w-md p-6 shadow-2xl animate-in zoom-in duration-200">
            <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2 text-blue-700">
                <i data-lucide="clipboard-check"></i> Rilevamento Campo
            </h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Note di Controllo</label>
                    <textarea id="checkpointNoteInput" rows="4" class="w-full border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-slate-50" placeholder="Inserisci osservazioni sul campo..."></textarea>
                </div>

                <div class="flex gap-3 pt-2">
                    <button onclick="closeCheckpointModal()" class="flex-1 py-3 border border-slate-200 rounded-xl font-bold text-slate-500 text-sm">Annulla</button>
                    <button onclick="confirmAddCheckpoint()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold text-sm shadow-lg shadow-blue-200">Salva Punto</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifiche -->
    <div id="notification" class="fixed top-24 left-1/2 -translate-x-1/2 z-[3000] transform -translate-y-24 opacity-0 transition-all duration-500 bg-slate-900 text-white px-6 py-2.5 rounded-full shadow-2xl text-xs font-bold border border-white/10">
        <span id="notifText"></span>
    </div>

    <script>
        lucide.createIcons();

        let map, userMarker, watchId = null;
        let fields = []; 
        let isTracking = false;
        let tempFieldCoords = null;
        let tempCheckpointCoords = null;
        
        // Logica Drag Pannello
        const panel = document.getElementById('statusPanel');
        const dragArea = document.getElementById('dragArea');
        const content = document.getElementById('panelContent');
        let startY, currentTranslateY = 0, isDragging = false;
        const MIN_HEIGHT = 85;

        dragArea.addEventListener('touchstart', (e) => {
            startY = e.touches[0].clientY;
            isDragging = true;
            panel.style.transition = 'none';
        }, {passive: true});

        window.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            const currentY = e.touches[0].clientY;
            const deltaY = currentY - startY;
            if (deltaY > 0 || currentTranslateY > 0) {
                const move = Math.max(0, deltaY + currentTranslateY);
                const maxTranslate = panel.offsetHeight - MIN_HEIGHT;
                if (move <= maxTranslate) panel.style.transform = `translateY(${move}px)`;
            }
        }, {passive: true});

        window.addEventListener('touchend', (e) => {
            if (!isDragging) return;
            isDragging = false;
            panel.style.transition = 'transform 0.3s cubic-bezier(0.17, 0.67, 0.83, 0.67)';
            const deltaY = e.changedTouches[0].clientY - startY;
            if (deltaY > 50) minimizePanel();
            else if (deltaY < -50) expandPanel();
            else panel.style.transform = `translateY(${currentTranslateY}px)`;
        });

        function minimizePanel() {
            currentTranslateY = panel.offsetHeight - MIN_HEIGHT;
            panel.style.transform = `translateY(${currentTranslateY}px)`;
            content.style.opacity = '0.4';
        }

        function expandPanel() {
            currentTranslateY = 0;
            panel.style.transform = `translateY(0px)`;
            content.style.opacity = '1';
        }

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([44.5, 11.5], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                attribution: '&copy; OSM' 
            }).addTo(map);
            L.control.zoom({ position: 'topright' }).addTo(map);

            // GESTIONE CLICK SEMPLIFICATA
            map.on('click', function(e) {
                const latlng = e.latlng;
                
                // Controlla se il tocco è dentro un campo
                let targetField = fields.find(f => latlng.distanceTo(f.latlng) <= f.radius);
                
                if (targetField) {
                    // Se siamo dentro, mostriamo il menu di scelta
                    tempFieldCoords = latlng;
                    tempCheckpointCoords = { latlng, fieldId: targetField.id };
                    openActionChoiceModal();
                } else {
                    // Se siamo fuori, andiamo direttamente a creare un nuovo campo
                    tempFieldCoords = latlng;
                    openFieldModal(false);
                }
            });

            loadLocalData();
        }

        // FUNZIONI MODAL SCELTA
        function openActionChoiceModal() {
            document.getElementById('actionChoiceModal').classList.replace('hidden', 'flex');
        }

        function closeActionChoiceModal() {
            document.getElementById('actionChoiceModal').classList.replace('flex', 'hidden');
        }

        function selectNewField() {
            closeActionChoiceModal();
            openFieldModal(false);
        }

        function selectNewCheckpoint() {
            closeActionChoiceModal();
            document.getElementById('checkpointModal').classList.replace('hidden', 'flex');
            document.getElementById('checkpointNoteInput').focus();
        }

        function openFieldModal(isManual = false) {
            document.getElementById('fieldModal').classList.replace('hidden', 'flex');
            const coordInputs = document.getElementById('coordsInputs');
            if(isManual) {
                coordInputs.classList.remove('hidden');
                document.getElementById('fieldLatInput').value = "";
                document.getElementById('fieldLonInput').value = "";
            } else {
                coordInputs.classList.add('hidden');
            }
            document.getElementById('fieldNameInput').focus();
        }

        function openManualCoordModal() { openFieldModal(true); }

        function closeFieldModal() {
            document.getElementById('fieldModal').classList.replace('flex', 'hidden');
            document.getElementById('fieldNameInput').value = "";
            document.getElementById('fieldCodeInput').value = "";
            tempFieldCoords = null;
        }

        function closeCheckpointModal() {
            document.getElementById('checkpointModal').classList.replace('flex', 'hidden');
            document.getElementById('checkpointNoteInput').value = "";
            tempCheckpointCoords = null;
        }

        function confirmAddField() {
            const name = document.getElementById('fieldNameInput').value.trim() || `Campo ${fields.length + 1}`;
            const code = document.getElementById('fieldCodeInput').value.trim() || `COD-${Math.floor(Math.random()*1000)}`;
            const category = document.getElementById('fieldCategoryInput').value;
            const radius = parseInt(document.getElementById('fieldRadiusInput').value) || 1000;
            
            let latlng = tempFieldCoords;
            if(!latlng) {
                const lat = parseFloat(document.getElementById('fieldLatInput').value);
                const lon = parseFloat(document.getElementById('fieldLonInput').value);
                if(isNaN(lat) || isNaN(lon)) {
                    showNotification("Coordinate non valide");
                    return;
                }
                latlng = L.latLng(lat, lon);
            }

            addFieldToMap({
                id: Date.now(),
                name: name,
                code: code,
                category: category,
                latlng: latlng,
                radius: radius,
                pathCoords: [],
                checkpoints: []
            });
            
            closeFieldModal();
            saveLocalData();
            showNotification(`Salvato: ${name} (${code})`);
        }

        function confirmAddCheckpoint() {
            const note = document.getElementById('checkpointNoteInput').value.trim();
            if (!note) {
                showNotification("Inserisci una nota per salvare.");
                return;
            }

            const field = fields.find(f => f.id === tempCheckpointCoords.fieldId);
            if (field) {
                const cpData = {
                    id: Date.now(),
                    latlng: tempCheckpointCoords.latlng,
                    note: note
                };
                field.checkpoints.push(cpData);
                renderCheckpointOnMap(cpData);
                closeCheckpointModal();
                saveLocalData();
                showNotification("Punto di controllo salvato.");
            }
        }

        function addFieldToMap(fieldData) {
            const colors = { cipolle: '#f97316', bunching: '#22c55e', brassiche: '#a855f7' };
            const color = colors[fieldData.category];

            const marker = L.marker(fieldData.latlng, {
                icon: L.divIcon({
                    html: `<div style="background: ${color}; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border: 3px solid white; shadow: 0 4px 6px rgba(0,0,0,0.2);"><i data-lucide="sprout" style="width: 14px; height: 14px;"></i></div>`,
                    className: '', iconSize: [32, 32], iconAnchor: [16, 16]
                })
            }).addTo(map);

            marker.bindPopup(`<div class="text-xs"><div class="font-black text-slate-800 uppercase">${fieldData.name}</div><div class="text-slate-500 font-mono text-[10px]">${fieldData.code}</div><div class="mt-2 text-slate-400">Raggio: ${fieldData.radius}m</div></div>`);

            const circle = L.circle(fieldData.latlng, {
                radius: fieldData.radius, color: color, fillColor: color, fillOpacity: 0.1, weight: 2, dashArray: '8, 8'
            }).addTo(map);

            const polyline = L.polyline(fieldData.pathCoords || [], { 
                color: '#000000', weight: 2, opacity: 0.8, dashArray: '5, 10' 
            }).addTo(map);

            const field = { ...fieldData, marker: marker, circle: circle, polyline: polyline, isInside: false };
            fields.push(field);
            
            if (field.checkpoints) {
                field.checkpoints.forEach(renderCheckpointOnMap);
            }

            updateFieldUI();
            lucide.createIcons();
        }

        function renderCheckpointOnMap(cp) {
            const cpMarker = L.marker(cp.latlng, {
                icon: L.divIcon({
                    html: `<div style="background: #2563eb; color: white; border-radius: 50%; width: 14px; height: 14px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                    className: '', iconSize: [14, 14], iconAnchor: [7, 7]
                })
            }).addTo(map);

            cpMarker.bindPopup(`
                <div class="text-xs p-1">
                    <div class="font-bold text-blue-700 mb-1 flex items-center gap-1">
                        <i data-lucide="clipboard-check" class="w-3 h-3"></i> Rilevamento
                    </div>
                    <div class="text-slate-600">${cp.note}</div>
                </div>
            `);
            
            cp.marker = cpMarker;
            lucide.createIcons();
        }

        function handleSearch() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!query) return;
            const foundField = fields.find(f => f.name.toLowerCase().includes(query) || f.code.toLowerCase().includes(query));
            if (foundField) {
                map.flyTo(foundField.latlng, 15);
                foundField.marker.openPopup();
                expandPanel();
                return;
            }
            searchLocation(query);
        }

        async function searchLocation(query) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await res.json();
                if (data.length > 0) map.flyTo(L.latLng(data[0].lat, data[0].lon), 15);
                else showNotification("Nessun risultato trovato");
            } catch (err) { showNotification("Errore di rete"); }
        }

        function toggleTracking() {
            const btn = document.getElementById('trackBtn');
            const tele = document.getElementById('telemetryPanel');
            if (isTracking) {
                if (watchId !== null) navigator.geolocation.clearWatch(watchId);
                watchId = null;
                isTracking = false;
                btn.innerHTML = '<i data-lucide="navigation" class="w-4 h-4"></i> Attiva GPS';
                btn.classList.remove('bg-rose-600');
                btn.classList.add('bg-slate-900');
                tele.classList.add('hidden');
                resetGlobalStatus();
            } else {
                if (!navigator.geolocation) return showNotification("GPS non supportato");
                showNotification("Ricerca GPS in corso...");
                watchId = navigator.geolocation.watchPosition((pos) => {
                    const accuracy = pos.coords.accuracy;
                    document.getElementById('accuracyVal').innerText = (accuracy ? accuracy.toFixed(0) : "?") + "m";
                    const latlng = L.latLng(pos.coords.latitude, pos.coords.longitude);
                    if (!userMarker) {
                        userMarker = L.marker(latlng, { icon: L.divIcon({ className: 'pulse-user', iconSize: [18, 18], iconAnchor: [9, 9] }) }).addTo(map);
                        map.flyTo(latlng, 15);
                    } else {
                        userMarker.setLatLng(latlng);
                    }
                    updateGeofencing(latlng);
                }, (err) => {
                    showNotification("Errore GPS: " + err.message);
                }, { 
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
                isTracking = true;
                tele.classList.remove('hidden');
                btn.innerHTML = '<i data-lucide="square" class="w-4 h-4"></i> Ferma GPS';
                btn.classList.remove('bg-slate-900');
                btn.classList.add('bg-rose-600');
            }
            setTimeout(() => lucide.createIcons(), 50);
        }

        function updateGeofencing(userPos) {
            let anyInside = false;
            let currentFieldName = "";
            fields.forEach(field => {
                const distance = userPos.distanceTo(field.latlng);
                const isInside = distance <= field.radius;
                if (isInside) {
                    anyInside = true;
                    currentFieldName = field.name;
                    field.isInside = true;
                    field.circle.setStyle({ fillOpacity: 0.3, dashArray: '' });
                    field.pathCoords.push([userPos.lat, userPos.lng]);
                    field.polyline.setLatLngs(field.pathCoords);
                } else {
                    field.circle.setStyle({ fillOpacity: 0.05, dashArray: '8, 8' });
                    field.isInside = false;
                }
            });
            const statusText = document.getElementById('statusText');
            const statusDot = document.getElementById('statusDot');
            const statusInd = document.getElementById('statusIndicator');
            if (anyInside) {
                statusText.innerText = `In: ${currentFieldName}`;
                statusDot.className = "w-2.5 h-2.5 rounded-full bg-green-500 animate-pulse";
                statusInd.classList.add('bg-green-50');
                statusInd.classList.remove('bg-slate-100');
            } else {
                statusText.innerText = "Monitoraggio...";
                statusDot.className = "w-2.5 h-2.5 rounded-full bg-slate-400";
                statusInd.classList.add('bg-slate-100');
                statusInd.classList.remove('bg-green-50');
            }
            saveLocalData();
        }

        function resetGlobalStatus() {
            document.getElementById('statusText').innerText = "Inattivo";
            document.getElementById('statusDot').className = "w-2.5 h-2.5 rounded-full bg-slate-400";
            const statusInd = document.getElementById('statusIndicator');
            statusInd.classList.add('bg-slate-100');
            statusInd.classList.remove('bg-green-50');
            fields.forEach(f => {
                f.circle.setStyle({ fillOpacity: 0.1, dashArray: '8, 8' });
                f.isInside = false;
            });
        }

        function updateFieldUI() {
            const categories = ['cipolle', 'bunching', 'brassiche'];
            let total = 0;
            categories.forEach(cat => {
                const section = document.getElementById(`cat-${cat}`);
                const list = document.getElementById(`list-${cat}`);
                const catFields = fields.filter(f => f.category === cat);
                if (catFields.length > 0) {
                    section.classList.remove('hidden');
                    list.innerHTML = "";
                    catFields.forEach(f => {
                        total++;
                        const item = document.createElement('div');
                        item.className = "flex items-center gap-3 p-3 bg-white border border-slate-100 rounded-2xl shadow-sm active:scale-[0.98] group relative overflow-hidden";
                        item.onclick = () => { map.flyTo(f.latlng, 15); f.marker.openPopup(); };
                        item.innerHTML = `<div class="w-10 h-10 rounded-xl bg-slate-50 flex flex-col items-center justify-center shrink-0 border border-slate-100"><i data-lucide="map" class="w-4 h-4 text-slate-400"></i><span class="text-[7px] font-bold text-slate-300 mt-1 uppercase">${cat.substring(0,3)}</span></div><div class="flex-1 min-w-0"><p class="text-[11px] font-black text-slate-800 uppercase leading-none truncate">${f.name}</p><p class="text-[9px] font-mono text-slate-400 mt-1">${f.code}</p></div><button onclick="event.stopPropagation(); deleteField(${f.id})" class="p-2 text-slate-200 hover:text-red-400 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                        list.appendChild(item);
                    });
                } else section.classList.add('hidden');
            });
            document.getElementById('emptyMsg').classList.toggle('hidden', total > 0);
            lucide.createIcons();
        }

        function deleteField(id) {
            const field = fields.find(f => f.id === id);
            if (field && confirm(`Eliminare il campo ${field.name}?`)) {
                map.removeLayer(field.marker); map.removeLayer(field.circle); map.removeLayer(field.polyline);
                if (field.checkpoints) {
                    field.checkpoints.forEach(cp => {
                        if (cp.marker) map.removeLayer(cp.marker);
                    });
                }
                fields = fields.filter(f => f.id !== id);
                updateFieldUI(); saveLocalData();
            }
        }

        function exportData() {
            const dataToExport = fields.map(f => ({
                id: f.id, name: f.name, code: f.code, category: f.category, latlng: f.latlng, radius: f.radius, pathCoords: f.pathCoords, checkpoints: f.checkpoints
            }));
            const jsonString = JSON.stringify(dataToExport);
            const el = document.createElement('textarea');
            el.value = jsonString;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            showNotification("Configurazione copiata negli appunti!");
        }

        function importData() {
            const jsonInput = prompt("Incolla qui il codice di configurazione ricevuto:");
            if (!jsonInput) return;
            try {
                const importedFields = JSON.parse(jsonInput);
                if (!Array.isArray(importedFields)) throw new Error();
                if (confirm("L'importazione sostituirà i campi attuali. Procedere?")) {
                    fields.forEach(f => {
                        map.removeLayer(f.marker); map.removeLayer(f.circle); map.removeLayer(f.polyline);
                        if (f.checkpoints) f.checkpoints.forEach(cp => { if(cp.marker) map.removeLayer(cp.marker); });
                    });
                    fields = [];
                    importedFields.forEach(fData => addFieldToMap(fData));
                    saveLocalData();
                    showNotification("Dati importati con successo!");
                }
            } catch (err) { showNotification("Errore: il codice non è valido."); }
        }

        function recenterOnUser() {
            if (userMarker) map.flyTo(userMarker.getLatLng(), 17);
            else showNotification("GPS non attivo.");
        }

        function showNotification(text) {
            const el = document.getElementById('notification');
            document.getElementById('notifText').innerText = text;
            el.classList.replace('opacity-0', 'opacity-100');
            el.classList.replace('-translate-y-24', 'translate-y-0');
            setTimeout(() => {
                el.classList.replace('opacity-100', 'opacity-0');
                el.classList.replace('translate-y-0', '-translate-y-24');
            }, 3000);
        }

        function saveLocalData() {
            localStorage.setItem('isolamenti_agricoli_v4', JSON.stringify(fields.map(f => ({
                id: f.id, name: f.name, code: f.code, category: f.category, latlng: f.latlng, radius: f.radius, pathCoords: f.pathCoords, checkpoints: f.checkpoints
            }))));
        }

        function loadLocalData() {
            const raw = localStorage.getItem('isolamenti_agricoli_v4');
            if (raw) JSON.parse(raw).forEach(fData => addFieldToMap(fData));
        }

        function clearAllData() {
            if (confirm("Attenzione: eliminare tutti i dati?")) {
                localStorage.removeItem('isolamenti_agricoli_v4');
                location.reload();
            }
        }

        window.onload = initMap;
    </script>
</body>
</html>