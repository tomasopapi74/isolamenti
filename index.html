<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Isolamenti - Navigazione e Controllo</title>
    <!-- Tailwind CSS per lo styling moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS e JS per le mappe interattive -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Lucide Icons per le icone dell'interfaccia -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        #map { height: calc(100vh - 80px); width: 100%; z-index: 1; }
        
        .custom-popup .leaflet-popup-content-wrapper { border-radius: 12px; padding: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        .pulse-user {
            width: 16px;
            height: 16px;
            background: #3b82f6;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
        }

        /* Stili per il pannello trascinabile */
        #statusPanel {
            transition: transform 0.3s cubic-bezier(0.17, 0.67, 0.83, 0.67);
            touch-action: none; /* Impedisce lo scroll del browser durante il drag */
        }
        
        .drag-handle {
            width: 40px;
            height: 5px;
            background-color: #e2e8f0;
            border-radius: 10px;
            margin: 0 auto 15px auto;
        }
    </style>
</head>
<body class="bg-slate-50 font-sans overflow-hidden">

    <header class="bg-white shadow-md p-4 sticky top-0 z-50 border-b border-slate-100 h-[80px]">
        <div class="max-w-6xl mx-auto flex items-center gap-4">
            <div class="flex items-center gap-2 shrink-0">
                <div class="bg-blue-600 p-2 rounded-lg shadow-md">
                    <i data-lucide="shield-check" class="text-white w-5 h-5"></i>
                </div>
                <h1 class="text-xl font-bold text-slate-800 tracking-tight hidden sm:block">Isolamenti</h1>
            </div>
            
            <div class="flex-1 flex gap-2">
                <div class="relative flex-1">
                    <i data-lucide="search" class="absolute left-3 top-3 text-slate-400 w-4 h-4"></i>
                    <input type="text" id="searchInput" placeholder="Indirizzo o coordinate..." 
                        class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                </div>
                <button onclick="searchLocation()" class="bg-blue-600 text-white px-4 py-2 rounded-xl font-semibold hover:bg-blue-700 active:scale-95 shadow-lg shadow-blue-100 transition-all">
                    Cerca
                </button>
            </div>
        </div>
    </header>

    <main class="relative">
        <div id="map"></div>

        <!-- Controlli Rapidi -->
        <div class="absolute top-4 left-4 z-[1000] flex flex-col gap-2">
            <button onclick="recenterOnUser()" class="bg-white p-3 rounded-xl shadow-lg hover:bg-slate-50 text-slate-700 border border-slate-100">
                <i data-lucide="locate-fixed" class="w-5 h-5"></i>
            </button>
            <button id="audioToggle" onclick="toggleAudio()" class="bg-white p-3 rounded-xl shadow-lg hover:bg-slate-50 text-slate-700 border border-slate-100">
                <i data-lucide="volume-2" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- Telemetria -->
        <div id="telemetryPanel" class="absolute top-4 right-4 z-[1000] hidden">
            <div class="bg-white/90 backdrop-blur px-3 py-2 rounded-xl shadow-lg border border-slate-100 text-[10px] font-bold text-slate-600 flex items-center gap-2">
                <div class="flex flex-col"><span class="text-slate-400">Tempo</span><span id="timerVal">00:00:00</span></div>
                <div class="h-4 w-px bg-slate-200"></div>
                <div class="flex flex-col"><span class="text-slate-400">Acc.</span><span id="accuracyVal">--m</span></div>
            </div>
        </div>

        <!-- BOTTOM SHEET TRASCINABILE -->
        <div id="statusPanel" class="absolute bottom-0 left-0 right-0 bg-white shadow-[0_-10px_25px_-5px_rgba(0,0,0,0.1)] rounded-t-[32px] p-5 z-[1000] border-t border-slate-100">
            <!-- Maniglia per il drag -->
            <div id="dragArea" class="cursor-grab active:cursor-grabbing pb-2">
                <div class="drag-handle"></div>
                <div class="flex items-center justify-between">
                    <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">Pannello Controllo</span>
                    <div id="statusIndicator" class="flex items-center gap-2 px-3 py-1 rounded-full text-[10px] font-bold bg-slate-100 text-slate-600">
                        <span id="statusDot" class="w-2 h-2 rounded-full bg-slate-400"></span>
                        <span id="statusText">Inattivo</span>
                    </div>
                </div>
            </div>

            <!-- Contenuto scorrevole del pannello -->
            <div id="panelContent" class="mt-4 space-y-4 overflow-hidden transition-opacity duration-200">
                <!-- Controllo Raggio -->
                <div id="radiusControl" class="hidden">
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Raggio Area</label>
                        <span id="radiusVal" class="text-xs font-bold text-blue-600">1000m</span>
                    </div>
                    <input type="range" id="radiusSlider" min="100" max="5000" step="100" value="1000" 
                        class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600" 
                        oninput="changeRadius(this.value)">
                </div>
                
                <div id="infoBox" class="space-y-3">
                    <p id="instructionText" class="text-xs text-slate-500 leading-tight">Fissa il centro sulla mappa per iniziare.</p>
                    <div id="distInfo" class="hidden text-xs font-bold text-slate-700 bg-slate-50 p-2 rounded-lg text-center border border-slate-100">
                        Confine: <span id="distVal">--</span>
                    </div>
                    <div class="flex gap-2">
                        <button id="trackBtn" onclick="toggleTracking()" class="flex-1 flex items-center justify-center gap-2 bg-slate-900 text-white py-3 rounded-xl font-bold active:scale-95 shadow-md">
                            <i data-lucide="navigation" class="w-4 h-4"></i> GPS
                        </button>
                        <button onclick="clearAllData()" class="bg-slate-100 text-red-500 p-3 rounded-xl hover:bg-red-50 transition-colors">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <!-- Lista Checkpoint -->
                <div id="checkpointList" class="border-t border-slate-50 pt-4 hidden">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-[10px] font-black uppercase text-slate-400 tracking-wider">Punti salvati</h3>
                        <span id="cpCount" class="text-[10px] bg-blue-600 text-white px-2 py-0.5 rounded-full font-bold">0</span>
                    </div>
                    <div id="listItems" class="max-h-48 overflow-y-auto space-y-2 pr-1 custom-scrollbar"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Checkpoint -->
    <div id="checkpointModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-[2000] p-4">
        <div class="bg-white rounded-3xl w-full max-w-md p-6 shadow-2xl">
            <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                <i data-lucide="map-pin" class="text-blue-600"></i> Nuovo Punto
            </h2>
            <div class="space-y-4">
                <textarea id="noteInput" rows="3" class="w-full border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="Note..."></textarea>
                <label class="flex flex-col items-center justify-center w-full h-24 border-2 border-slate-200 border-dashed rounded-xl cursor-pointer hover:bg-slate-50">
                    <i data-lucide="camera" class="w-6 h-6 text-slate-400"></i>
                    <span class="text-[10px] text-slate-500 mt-1">Foto opzionale</span>
                    <input type="file" id="photoInput" accept="image/*" class="hidden" onchange="previewImage(this)">
                </label>
                <div id="imagePreview" class="hidden mt-2 rounded-xl overflow-hidden h-24 border border-slate-200"></div>
                <div class="flex gap-3 pt-2">
                    <button onclick="closeModal()" class="flex-1 py-3 border border-slate-200 rounded-xl font-bold text-slate-500 text-sm">Annulla</button>
                    <button onclick="saveCheckpoint()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold text-sm">Salva</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifiche -->
    <div id="notification" class="fixed top-24 left-1/2 -translate-x-1/2 z-[3000] transform -translate-y-24 opacity-0 transition-all duration-500 bg-slate-900 text-white px-6 py-2.5 rounded-full shadow-2xl text-xs font-bold border border-white/10">
        <span id="notifText"></span>
    </div>

    <script>
        lucide.createIcons();

        let map, userMarker, centerPoint, centerMarker, targetCircle, breadcrumbs;
        let isTracking = false, watchId = null, checkpoints = [], pathCoords = [];
        let tempCoords = null, currentRadius = 1000, audioEnabled = true;
        let lastStatusInside = null, startTime = null, timerInterval = null;

        // LOGICA DRAG PANNELLO
        const panel = document.getElementById('statusPanel');
        const dragArea = document.getElementById('dragArea');
        const content = document.getElementById('panelContent');
        let startY, currentTranslateY = 0, isDragging = false;
        const MIN_HEIGHT = 60; // Altezza visibile quando abbassato
        
        dragArea.addEventListener('touchstart', (e) => {
            startY = e.touches[0].clientY;
            isDragging = true;
            panel.style.transition = 'none';
        });

        window.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            const currentY = e.touches[0].clientY;
            const deltaY = currentY - startY;
            
            // Permetti solo di scendere o tornare su
            if (deltaY > 0 || currentTranslateY > 0) {
                const move = Math.max(0, deltaY);
                panel.style.transform = `translateY(${move}px)`;
            }
        });

        window.addEventListener('touchend', (e) => {
            if (!isDragging) return;
            isDragging = false;
            panel.style.transition = 'transform 0.3s cubic-bezier(0.17, 0.67, 0.83, 0.67)';
            
            const endY = e.changedTouches[0].clientY;
            const deltaY = endY - startY;
            
            // Soglia per scattare (Snap)
            if (deltaY > 100) {
                minimizePanel();
            } else {
                expandPanel();
            }
        });

        function minimizePanel() {
            const panelHeight = panel.offsetHeight;
            currentTranslateY = panelHeight - MIN_HEIGHT;
            panel.style.transform = `translateY(${currentTranslateY}px)`;
            content.style.opacity = '0';
        }

        function expandPanel() {
            currentTranslateY = 0;
            panel.style.transform = `translateY(0px)`;
            content.style.opacity = '1';
        }

        // MAPPA E LOGICA
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([42.5, 12.5], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);
            L.control.zoom({ position: 'topright' }).addTo(map);

            breadcrumbs = L.polyline([], { color: '#000000', weight: 2, opacity: 0.8, dashArray: '5, 10' }).addTo(map);

            map.on('click', function(e) {
                if (!centerPoint) {
                    setCenterPoint(e.latlng);
                } else if (isInsideCircle(e.latlng)) {
                    openCheckpointModal(e.latlng);
                } else {
                    showNotification("Fuori raggio!");
                }
            });
            loadLocalData();
        }

        function setCenterPoint(latlng, savedRadius = null) {
            if (centerMarker) map.removeLayer(centerMarker);
            if (targetCircle) map.removeLayer(targetCircle);
            centerPoint = latlng;
            if (savedRadius) currentRadius = savedRadius;
            
            centerMarker = L.marker(latlng, {
                draggable: true,
                icon: L.divIcon({
                    html: `<div style="background: #0f172a; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border: 3px solid white; shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);"><i data-lucide="flag" style="width: 14px; height: 14px;"></i></div>`,
                    className: '', iconSize: [32, 32], iconAnchor: [16, 16]
                })
            }).addTo(map);

            targetCircle = L.circle(latlng, {
                radius: currentRadius, color: '#3b82f6', fillColor: '#3b82f6', fillOpacity: 0.1, weight: 2, dashArray: '8, 8'
            }).addTo(map);

            centerMarker.on('dragend', function() {
                centerPoint = centerMarker.getLatLng();
                targetCircle.setLatLng(centerPoint);
                updateGeofenceColor();
                saveLocalData();
            });

            document.getElementById('checkpointList').classList.remove('hidden');
            document.getElementById('radiusControl').classList.remove('hidden');
            document.getElementById('instructionText').innerText = "Tocca nel cerchio per aggiungere checkpoint.";
            document.getElementById('radiusSlider').value = currentRadius;
            document.getElementById('radiusVal').innerText = currentRadius + 'm';
            saveLocalData();
            lucide.createIcons();
        }

        function changeRadius(val) {
            currentRadius = parseInt(val);
            document.getElementById('radiusVal').innerText = currentRadius + 'm';
            if (targetCircle) {
                targetCircle.setRadius(currentRadius);
                updateGeofenceColor();
                saveLocalData();
            }
        }

        function toggleAudio() {
            audioEnabled = !audioEnabled;
            const icon = document.getElementById('audioToggle').querySelector('i');
            icon.setAttribute('data-lucide', audioEnabled ? 'volume-2' : 'volume-x');
            showNotification(audioEnabled ? "Audio attivato" : "Audio disattivato");
            lucide.createIcons();
        }

        function speak(text) {
            if (!audioEnabled) return;
            const ut = new SpeechSynthesisUtterance(text);
            ut.lang = 'it-IT';
            window.speechSynthesis.speak(ut);
        }

        function toggleTracking() {
            const btn = document.getElementById('trackBtn');
            const tele = document.getElementById('telemetryPanel');
            if (isTracking) {
                navigator.geolocation.clearWatch(watchId);
                isTracking = false;
                btn.innerHTML = `<i data-lucide="navigation" class="w-4 h-4"></i> GPS`;
                btn.classList.replace('bg-rose-600', 'bg-slate-900');
                if (userMarker) map.removeLayer(userMarker);
                userMarker = null;
                tele.classList.add('hidden');
                document.getElementById('distInfo').classList.add('hidden');
                stopTimer();
                resetStatusUI();
            } else {
                if (!navigator.geolocation) return showNotification("GPS non supportato");
                showNotification("Aggancio segnale...");
                watchId = navigator.geolocation.watchPosition((pos) => {
                    const latlng = [pos.coords.latitude, pos.coords.longitude];
                    document.getElementById('accuracyVal').innerText = pos.coords.accuracy.toFixed(0) + "m";
                    if (!userMarker) {
                        userMarker = L.marker(latlng, { icon: L.divIcon({ className: 'pulse-user', iconSize: [16, 16], iconAnchor: [8, 8] }) }).addTo(map);
                        map.flyTo(latlng, 15);
                        startTimer();
                    } else { userMarker.setLatLng(latlng); }
                    pathCoords.push(latlng);
                    breadcrumbs.setLatLngs(pathCoords);
                    updateGeofenceColor();
                }, (err) => showNotification("Errore: " + err.message), { enableHighAccuracy: true });
                isTracking = true;
                tele.classList.remove('hidden');
                btn.innerHTML = `<i data-lucide="square" class="w-4 h-4"></i> Stop`;
                btn.classList.replace('bg-slate-900', 'bg-rose-600');
            }
            lucide.createIcons();
        }

        function updateGeofenceColor() {
            if (!centerPoint || !userMarker) return;
            const userPos = userMarker.getLatLng();
            const distance = userPos.distanceTo(centerPoint);
            const isInside = distance <= currentRadius;
            
            const distInfo = document.getElementById('distInfo');
            distInfo.classList.remove('hidden');
            const diff = Math.abs(currentRadius - distance).toFixed(0);
            document.getElementById('distVal').innerText = isInside ? `${diff}m dal bordo` : `${diff}m fuori`;

            const statusText = document.getElementById('statusText');
            const statusDot = document.getElementById('statusDot');
            const statusIndicator = document.getElementById('statusIndicator');

            if (isInside) {
                targetCircle.setStyle({ color: '#22c55e', fillColor: '#22c55e', fillOpacity: 0.2, dashArray: '' });
                statusText.innerText = "Isolamento OK";
                statusDot.className = "w-2 h-2 rounded-full bg-green-500";
                if (lastStatusInside === false) speak("Bentornato in area.");
            } else {
                targetCircle.setStyle({ color: '#ef4444', fillColor: '#ef4444', fillOpacity: 0.3, dashArray: '' });
                statusText.innerText = "Allarme: Fuori!";
                statusDot.className = "w-2 h-2 rounded-full bg-red-500 animate-pulse";
                if (lastStatusInside === true || lastStatusInside === null) speak("Allarme. Sei uscito dall'area.");
            }
            lastStatusInside = isInside;
        }

        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const h = Math.floor(elapsed / 3600000).toString().padStart(2, '0');
                const m = Math.floor((elapsed % 3600000) / 60000).toString().padStart(2, '0');
                const s = Math.floor((elapsed % 60000) / 1000).toString().padStart(2, '0');
                document.getElementById('timerVal').innerText = `${h}:${m}:${s}`;
            }, 1000);
        }

        function stopTimer() { clearInterval(timerInterval); document.getElementById('timerVal').innerText = "00:00:00"; }

        function resetStatusUI() {
            document.getElementById('statusText').innerText = "Inattivo";
            document.getElementById('statusDot').className = "w-2 h-2 rounded-full bg-slate-400";
            if(targetCircle) targetCircle.setStyle({ color: '#3b82f6', fillColor: '#3b82f6', fillOpacity: 0.1, dashArray: '8, 8' });
            pathCoords = []; breadcrumbs.setLatLngs([]); lastStatusInside = null;
        }

        function isInsideCircle(latlng) { return centerPoint ? latlng.distanceTo(centerPoint) <= currentRadius : false; }

        async function searchLocation() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await res.json();
                if (data.length > 0) {
                    const latlng = L.latLng(data[0].lat, data[0].lon);
                    map.flyTo(latlng, 16);
                    setCenterPoint(latlng);
                } else showNotification("Non trovato");
            } catch (err) { showNotification("Errore ricerca"); }
        }

        function openCheckpointModal(latlng) { tempCoords = latlng; document.getElementById('checkpointModal').classList.replace('hidden', 'flex'); }
        function closeModal() {
            document.getElementById('checkpointModal').classList.replace('flex', 'hidden');
            document.getElementById('noteInput').value = ""; document.getElementById('photoInput').value = "";
            document.getElementById('imagePreview').innerHTML = ""; document.getElementById('imagePreview').classList.add('hidden');
        }

        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                    preview.classList.remove('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveCheckpoint() {
            const cp = { id: Date.now(), coords: tempCoords, note: document.getElementById('noteInput').value || "Nota" };
            checkpoints.push(cp); renderCheckpointOnMap(cp); updateCheckpointList();
            saveLocalData(); closeModal(); showNotification("Salvato!");
        }

        function renderCheckpointOnMap(cp) {
            const marker = L.marker(cp.coords, {
                icon: L.divIcon({
                    html: `<div style="background: white; border: 2px solid #3b82f6; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"><div style="background: #3b82f6; width: 6px; height: 6px; border-radius: 50%;"></div></div>`,
                    className: '', iconSize: [16, 16], iconAnchor: [8, 8]
                })
            }).addTo(map);
            marker.bindPopup(`<div class="text-xs font-bold">${cp.note}</div>`);
        }

        function updateCheckpointList() {
            const container = document.getElementById('listItems');
            document.getElementById('cpCount').innerText = checkpoints.length;
            container.innerHTML = "";
            [...checkpoints].reverse().forEach(cp => {
                const el = document.createElement('div');
                el.className = "flex items-center gap-3 p-2 bg-white border border-slate-100 rounded-xl text-xs";
                el.innerHTML = `<i data-lucide="map-pin" class="w-3 h-3 text-blue-500"></i><span class="truncate font-bold">${cp.note}</span>`;
                container.appendChild(el);
            });
            lucide.createIcons();
        }

        function recenterOnUser() { if (userMarker) map.flyTo(userMarker.getLatLng(), 17); else showNotification("GPS non attivo"); }

        function showNotification(text) {
            const el = document.getElementById('notification');
            document.getElementById('notifText').innerText = text;
            el.classList.replace('opacity-0', 'opacity-100');
            el.classList.replace('-translate-y-24', 'translate-y-0');
            setTimeout(() => {
                el.classList.replace('opacity-100', 'opacity-0');
                el.classList.replace('translate-y-0', '-translate-y-24');
            }, 2500);
        }

        function saveLocalData() {
            const data = { center: centerPoint, radius: currentRadius, checkpoints: checkpoints };
            localStorage.setItem('isolamenti_v3', JSON.stringify(data));
        }

        function loadLocalData() {
            const raw = localStorage.getItem('isolamenti_v3');
            if (!raw) return;
            const data = JSON.parse(raw);
            if (data.center) { setCenterPoint(data.center, data.radius); map.setView(data.center, 14); }
            if (data.checkpoints) { checkpoints = data.checkpoints; checkpoints.forEach(renderCheckpointOnMap); updateCheckpointList(); }
        }

        function clearAllData() {
            if (confirm("Reset totale?")) { localStorage.removeItem('isolamenti_v3'); location.reload(); }
        }

        window.onload = initMap;
    </script>
</body>
</html>