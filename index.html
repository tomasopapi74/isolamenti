<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoGuard GPS - Navigazione e Controllo</title>
    <!-- Tailwind CSS per lo styling moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS e JS per le mappe interattive -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Lucide Icons per le icone dell'interfaccia -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Dimensioni della mappa: occupa tutto lo spazio tranne l'header */
        #map { height: calc(100vh - 180px); width: 100%; z-index: 1; }
        
        /* Stile personalizzato per i popup della mappa */
        .custom-popup .leaflet-popup-content-wrapper { border-radius: 12px; padding: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        /* Animazione pulsante per la posizione dell'utente */
        .pulse-user {
            width: 16px;
            height: 16px;
            background: #3b82f6;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        /* Scrollbar personalizzata per la lista dei checkpoint */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 font-sans overflow-hidden">

    <!-- Header e Barra di Ricerca -->
    <header class="bg-white shadow-md p-4 sticky top-0 z-50 border-b border-slate-100">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row md:items-center gap-4">
            <div class="flex items-center gap-2 shrink-0">
                <div class="bg-blue-600 p-2 rounded-lg">
                    <i data-lucide="map" class="text-white w-5 h-5"></i>
                </div>
                <h1 class="text-xl font-bold text-slate-800 tracking-tight">GeoGuard GPS</h1>
            </div>
            
            <div class="flex-1 flex gap-2">
                <div class="relative flex-1">
                    <i data-lucide="search" class="absolute left-3 top-3 text-slate-400 w-4 h-4"></i>
                    <input type="text" id="searchInput" placeholder="Cerca indirizzo o 'lat, lon'..." 
                        class="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all shadow-sm text-sm">
                </div>
                <button onclick="searchLocation()" class="bg-blue-600 text-white px-5 py-2.5 rounded-xl font-semibold hover:bg-blue-700 transition-all active:scale-95 shadow-lg shadow-blue-100 flex items-center gap-2">
                    <span>Cerca</span>
                </button>
            </div>
        </div>
    </header>

    <main class="relative">
        <!-- Area Mappa -->
        <div id="map" class="bg-slate-200"></div>

        <!-- Pannello Informativo Floating -->
        <div id="statusPanel" class="absolute bottom-6 left-4 right-4 md:left-auto md:right-6 md:w-80 bg-white/95 backdrop-blur-md shadow-2xl rounded-2xl p-5 z-[1000] border border-slate-100 transition-all">
            <div class="flex items-center justify-between mb-4">
                <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">Stato GPS</span>
                <div id="statusIndicator" class="flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold bg-slate-100 text-slate-600 shadow-sm">
                    <span id="statusDot" class="w-2.5 h-2.5 rounded-full bg-slate-400"></span>
                    <span id="statusText">Inattivo</span>
                </div>
            </div>
            
            <div id="infoBox" class="text-sm text-slate-600 space-y-3">
                <p id="instructionText" class="leading-tight">Tocca la mappa per fissare il punto centrale dell'area di controllo.</p>
                <div class="flex gap-2">
                    <button id="trackBtn" onclick="toggleTracking()" class="flex-1 flex items-center justify-center gap-2 bg-slate-900 text-white py-3 rounded-xl hover:bg-black transition-all font-bold active:scale-95 shadow-lg">
                        <i data-lucide="navigation" class="w-4 h-4"></i> Attiva Tracking
                    </button>
                </div>
            </div>

            <!-- Lista dei Checkpoint Salvati -->
            <div id="checkpointList" class="mt-5 border-t border-slate-100 pt-4 hidden">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xs font-black uppercase text-slate-400 tracking-wider">Checkpoint</h3>
                    <span id="cpCount" class="text-[10px] bg-blue-600 text-white px-2 py-0.5 rounded-full font-bold">0</span>
                </div>
                <div id="listItems" class="max-h-48 overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                    <!-- Elementi inseriti dinamicamente via JS -->
                </div>
            </div>
        </div>
    </main>

    <!-- Modal per creazione Checkpoint -->
    <div id="checkpointModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-[2000] p-4">
        <div class="bg-white rounded-3xl w-full max-w-md p-6 shadow-2xl animate-in zoom-in duration-200">
            <div class="flex items-center gap-3 mb-6">
                <div class="bg-blue-100 p-2.5 rounded-xl text-blue-600">
                    <i data-lucide="map-pin"></i>
                </div>
                <h2 class="text-xl font-bold text-slate-800">Nuovo Checkpoint</h2>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Descrizione</label>
                    <textarea id="noteInput" rows="3" class="w-full border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 outline-none transition-all resize-none text-sm" placeholder="Aggiungi una nota per questo luogo..."></textarea>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Foto</label>
                    <label class="flex flex-col items-center justify-center w-full h-24 border-2 border-slate-200 border-dashed rounded-xl cursor-pointer hover:bg-slate-50 transition-all group">
                        <div class="flex flex-col items-center justify-center pt-2 pb-2">
                            <i data-lucide="camera" class="w-6 h-6 text-slate-400 group-hover:text-blue-500 transition-colors"></i>
                            <p class="text-[10px] text-slate-500 mt-1">Clicca per allegare immagine</p>
                        </div>
                        <input type="file" id="photoInput" accept="image/*" class="hidden" onchange="previewImage(this)">
                    </label>
                    <div id="imagePreview" class="hidden mt-2 rounded-xl overflow-hidden h-24 bg-slate-100 border border-slate-200"></div>
                </div>

                <div class="flex gap-3 pt-4">
                    <button onclick="closeModal()" class="flex-1 py-3 border border-slate-200 rounded-xl font-bold text-slate-600 hover:bg-slate-50 transition-all active:scale-95 text-sm">Annulla</button>
                    <button onclick="saveCheckpoint()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-all active:scale-95 shadow-lg shadow-blue-200 text-sm">Salva</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback visivo (Notifiche) -->
    <div id="notification" class="fixed top-24 left-1/2 -translate-x-1/2 z-[3000] transform -translate-y-24 opacity-0 transition-all duration-500 bg-slate-900 text-white px-6 py-2.5 rounded-full shadow-2xl pointer-events-none flex items-center gap-3 border border-white/10">
        <span id="notifText" class="text-xs font-bold tracking-wide"></span>
    </div>

    <script>
        // Inizializza le icone Lucide
        lucide.createIcons();

        let map, userMarker, centerPoint, centerMarker, targetCircle;
        let isTracking = false;
        let watchId = null;
        let checkpoints = [];
        let tempCoords = null;

        // Inizializzazione della mappa Leaflet
        function initMap() {
            // Coordinate di default (Italia centrale)
            map = L.map('map', { zoomControl: false }).setView([42.5, 12.5], 6);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);

            L.control.zoom({ position: 'topright' }).addTo(map);

            // Gestione clic sulla mappa per il centro o i checkpoint
            map.on('click', function(e) {
                if (!centerPoint) {
                    setCenterPoint(e.latlng);
                } else if (isInsideCircle(e.latlng)) {
                    openCheckpointModal(e.latlng);
                } else {
                    showNotification("Puoi segnare punti solo all'interno del raggio di 1km!");
                }
            });
        }

        // Funzione per impostare il punto di origine della navigazione
        function setCenterPoint(latlng) {
            if (centerMarker) map.removeLayer(centerMarker);
            if (targetCircle) map.removeLayer(targetCircle);

            centerPoint = latlng;
            
            // Marker del centro personalizzato (Bandiera)
            centerMarker = L.marker(latlng, {
                draggable: true,
                icon: L.divIcon({
                    html: `<div style="background: #0f172a; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);"><i data-lucide="flag" style="width: 14px; height: 14px;"></i></div>`,
                    className: '',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                })
            }).addTo(map);

            // Cerchio di controllo (Geofence)
            targetCircle = L.circle(latlng, {
                radius: 1000,
                color: '#3b82f6',
                fillColor: '#3b82f6',
                fillOpacity: 0.1,
                weight: 2,
                dashArray: '8, 8'
            }).addTo(map);

            // Spostamento del centro tramite trascinamento
            centerMarker.on('dragend', function() {
                centerPoint = centerMarker.getLatLng();
                targetCircle.setLatLng(centerPoint);
                updateGeofenceColor();
            });

            document.getElementById('checkpointList').classList.remove('hidden');
            document.getElementById('instructionText').innerText = "Area definita. Tocca nel cerchio per aggiungere note o attiva il GPS per il controllo.";
            showNotification("Punto centrale fissato!");
            lucide.createIcons();
        }

        // Funzione per attivare/disattivare la geolocalizzazione in tempo reale
        function toggleTracking() {
            const btn = document.getElementById('trackBtn');
            if (isTracking) {
                navigator.geolocation.clearWatch(watchId);
                isTracking = false;
                btn.innerHTML = `<i data-lucide="navigation" class="w-4 h-4"></i> Attiva Tracking`;
                btn.classList.replace('bg-rose-600', 'bg-slate-900');
                if (userMarker) map.removeLayer(userMarker);
                userMarker = null;
                resetStatusUI();
            } else {
                if (!navigator.geolocation) {
                    showNotification("Errore: GPS non supportato dal browser.");
                    return;
                }
                
                showNotification("Ricerca della tua posizione...");
                watchId = navigator.geolocation.watchPosition(
                    (pos) => {
                        const latlng = [pos.coords.latitude, pos.coords.longitude];
                        if (!userMarker) {
                            userMarker = L.marker(latlng, {
                                icon: L.divIcon({ className: 'pulse-user', iconSize: [16, 16], iconAnchor: [8, 8] })
                            }).addTo(map);
                            map.flyTo(latlng, 15);
                        } else {
                            userMarker.setLatLng(latlng);
                        }
                        updateGeofenceColor();
                    },
                    (err) => showNotification("Errore GPS: " + err.message),
                    { enableHighAccuracy: true }
                );
                
                isTracking = true;
                btn.innerHTML = `<i data-lucide="square" class="w-4 h-4"></i> Ferma GPS`;
                btn.classList.replace('bg-slate-900', 'bg-rose-600');
            }
            lucide.createIcons();
        }

        // Logica principale: cambia colore del cerchio in base alla posizione
        function updateGeofenceColor() {
            if (!centerPoint || !userMarker) return;

            const userPos = userMarker.getLatLng();
            const distance = userPos.distanceTo(centerPoint);
            const statusText = document.getElementById('statusText');
            const statusDot = document.getElementById('statusDot');
            const statusIndicator = document.getElementById('statusIndicator');

            if (distance <= 1000) {
                // DENTRO IL CERCHIO -> VERDE
                targetCircle.setStyle({ color: '#22c55e', fillColor: '#22c55e', fillOpacity: 0.2, dashArray: '' });
                statusText.innerText = "Posizione OK";
                statusDot.className = "w-2.5 h-2.5 rounded-full bg-green-500";
                statusIndicator.className = "flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold bg-green-50 text-green-700 border border-green-100";
            } else {
                // FUORI DAL CERCHIO -> ROSSO
                targetCircle.setStyle({ color: '#ef4444', fillColor: '#ef4444', fillOpacity: 0.3, dashArray: '' });
                statusText.innerText = "Fuori area!";
                statusDot.className = "w-2.5 h-2.5 rounded-full bg-red-500 animate-pulse";
                statusIndicator.className = "flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold bg-red-50 text-red-700 border border-red-100";
            }
        }

        function resetStatusUI() {
            document.getElementById('statusText').innerText = "Inattivo";
            document.getElementById('statusDot').className = "w-2.5 h-2.5 rounded-full bg-slate-400";
            document.getElementById('statusIndicator').className = "flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold bg-slate-100 text-slate-600 shadow-sm";
            if(targetCircle) targetCircle.setStyle({ color: '#3b82f6', fillColor: '#3b82f6', fillOpacity: 0.1, dashArray: '8, 8' });
        }

        function isInsideCircle(latlng) {
            if (!centerPoint) return false;
            return latlng.distanceTo(centerPoint) <= 1000;
        }

        // Ricerca località tramite Nominatim API (OpenStreetMap)
        async function searchLocation() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            // Controllo se sono coordinate dirette
            const coordRegex = /^([-+]?\d*\.?\d+),\s*([-+]?\d*\.?\d+)$/;
            const match = query.match(coordRegex);
            
            if (match) {
                const latlng = L.latLng(parseFloat(match[1]), parseFloat(match[2]));
                map.flyTo(latlng, 16);
                setCenterPoint(latlng);
                return;
            }

            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await res.json();
                if (data.length > 0) {
                    const latlng = L.latLng(data[0].lat, data[0].lon);
                    map.flyTo(latlng, 16);
                    setCenterPoint(latlng);
                } else {
                    showNotification("Località non trovata.");
                }
            } catch (err) {
                showNotification("Errore di connessione.");
            }
        }

        // Gestione dei Checkpoint (Modal e Salvataggio)
        function openCheckpointModal(latlng) {
            tempCoords = latlng;
            document.getElementById('checkpointModal').classList.replace('hidden', 'flex');
        }

        function closeModal() {
            document.getElementById('checkpointModal').classList.replace('flex', 'hidden');
            document.getElementById('noteInput').value = "";
            document.getElementById('photoInput').value = "";
            document.getElementById('imagePreview').innerHTML = "";
            document.getElementById('imagePreview').classList.add('hidden');
            tempCoords = null;
        }

        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                    preview.classList.remove('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveCheckpoint() {
            const note = document.getElementById('noteInput').value || "Senza descrizione";
            const photoFile = document.getElementById('photoInput').files[0];
            
            const cp = {
                id: Date.now(),
                coords: tempCoords,
                note: note,
                photo: photoFile ? URL.createObjectURL(photoFile) : null
            };

            checkpoints.push(cp);
            renderCheckpointOnMap(cp);
            updateCheckpointList();
            closeModal();
            showNotification("Checkpoint salvato!");
        }

        function renderCheckpointOnMap(cp) {
            const marker = L.marker(cp.coords, {
                icon: L.divIcon({
                    html: `<div style="background: white; border: 2px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"><div style="background: #3b82f6; width: 8px; height: 8px; border-radius: 50%;"></div></div>`,
                    className: '',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(map);

            const popupHtml = `
                <div class="custom-popup p-1 max-w-[180px]">
                    <p class="font-bold text-slate-800 text-xs mb-1 border-b pb-1">Checkpoint</p>
                    <p class="text-[11px] text-slate-600 mb-2">${cp.note}</p>
                    ${cp.photo ? `<img src="${cp.photo}" class="rounded-lg w-full h-24 object-cover shadow-sm">` : ''}
                </div>
            `;
            marker.bindPopup(popupHtml);
        }

        function updateCheckpointList() {
            const container = document.getElementById('listItems');
            document.getElementById('cpCount').innerText = checkpoints.length;
            container.innerHTML = "";

            // Mostra i più recenti in alto
            [...checkpoints].reverse().forEach(cp => {
                const el = document.createElement('div');
                el.className = "flex items-center gap-3 p-3 bg-white border border-slate-100 rounded-xl hover:border-blue-400 cursor-pointer transition-all active:scale-[0.97] group shadow-sm";
                el.onclick = () => map.flyTo(cp.coords, 17);
                el.innerHTML = `
                    <div class="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center shrink-0 group-hover:bg-blue-600 group-hover:text-white transition-all">
                        <i data-lucide="${cp.photo ? 'image' : 'map-pin'}" class="w-4 h-4"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-bold text-slate-800 truncate">${cp.note}</p>
                        <p class="text-[9px] text-slate-400 font-mono tracking-tighter">${cp.coords.lat.toFixed(4)}, ${cp.coords.lng.toFixed(4)}</p>
                    </div>
                `;
                container.appendChild(el);
            });
            lucide.createIcons();
        }

        function showNotification(text) {
            const el = document.getElementById('notification');
            document.getElementById('notifText').innerText = text;
            el.classList.remove('-translate-y-24', 'opacity-0');
            el.classList.add('translate-y-0', 'opacity-100');
            setTimeout(() => {
                el.classList.add('-translate-y-24', 'opacity-0');
                el.classList.remove('translate-y-0', 'opacity-100');
            }, 3000);
        }

        // Caricamento iniziale
        window.onload = initMap;
    </script>
</body>
</html>